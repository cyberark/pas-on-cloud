{
   "Resources": {
      "LogGroup": {
         "Type": "AWS::Logs::LogGroup",
         "Properties": {
            "RetentionInDays": 30
         },
         "DeletionPolicy": "Retain"
      },
      "DeployBucket": {
         "Type": "AWS::S3::Bucket",
         "Properties": {
            "AccessControl": "Private"
         }
      },
      "LambdaDeployRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Version": "2012-10-17",
               "Statement": [{
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [
                        "lambda.amazonaws.com"
                     ]
                  },
                  "Action": [
                     "sts:AssumeRole"
                  ]
               }]
            },
            "Policies": [{
                  "PolicyName": "CloudWatch",
                  "PolicyDocument": {
                     "Version": "2012-10-17",
                     "Statement": [{
                        "Effect": "Allow",
                        "Action": [
                           "logs:CreateLogGroup",
                           "logs:CreateLogStream",
                           "logs:DescribeLogGroups",
                           "logs:DescribeLogStreams",
                           "logs:PutLogEvents"
                        ],
                        "Resource": [
                           "*"
                        ]
                     }]
                  }
               },
               {
                  "PolicyName": "SSM",
                  "PolicyDocument": {
                     "Version": "2012-10-17",
                     "Statement": [{
                        "Effect": "Allow",
                        "Action": [
                           "ssm:PutParameter",
                           "ssm:DeleteParameter"
                        ],
                        "Resource": [{
                           "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
                        }]
                     }]
                  }
               },
               {
                  "PolicyName": "S3",
                  "PolicyDocument": {
                     "Version": "2012-10-17",
                     "Statement": [{
                        "Effect": "Allow",
                        "Action": [
                           "s3:GetObject",
                           "s3:GetObjectVersion",
                           "s3:PutObject",
                           "s3:DeleteObject",
                           "s3:DeleteObjectVersion"
                        ],
                        "Resource": [
						               { "Fn::Sub": "arn:${AWS::Partition}:s3:::${DeployBucket}/*" },
                           { "Fn::Sub": "arn:${AWS::Partition}:s3:::${VaultFilesBucket}/*" }
                        ]
                     }]
                  }
               }
            ]
         },
         "Condition": "EULACondition"
      },
      "LambdaLogDenyRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [
                                "lambda.amazonaws.com"
                            ]
                        },
                        "Action": [
                            "sts:AssumeRole"
                        ]
                    }
                ]
            },
            "Policies": [
               {
                  "PolicyName": "denyLambdaLogging",
                  "PolicyDocument": {
                     "Version": "2012-10-17",
                     "Statement": [
                        {
                           "Effect": "Deny",
                           "Action": [
                              "logs:*"
                           ],
                           "Resource": "*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "StorePasswordLambda": {
         "Type": "AWS::Lambda::Function",
         "Properties": {
            "Description": "Saves given password to parameter store as SecureString",
            "Code": {
               "ZipFile": {
                  "Fn::Join": [
                     "\n", [
                        "import uuid",
                        "import boto3",
                        "import cfnresponse",
                        "",
                        "def storePassword(name, value):",
                        "    ssmClient = boto3.client('ssm')",
                        "    return ssmClient.put_parameter(",
                        "        Name = name,",
                        "        Value = value,",
                        "        Type = 'SecureString'",
                        "    )",
                        "",
                        "def deletePassword(name):",
                        "    ssmClient = boto3.client('ssm')",
                        "    return ssmClient.delete_parameter(",
                        "        Name = name",
                        "    )",
                        "",
                        "def lambda_handler(event, context):",
                        "",
                        "    physicalResourceId = str(uuid.uuid4())",
                        "    if 'PhysicalResourceId' in event:",
                        "        physicalResourceId = event['PhysicalResourceId']",
                        "",
                        "    if 'Password' not in event['ResourceProperties'] or not event['ResourceProperties']['Password']:",
                        "            print 'The property Password must not be empty'",
                        "            return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)",
                        "",
                        "    try:",
                        "        if event['RequestType'] == 'Delete':",
                        "            deletePassword(physicalResourceId)",
                        "            print 'Password successfully deleted. Id='+physicalResourceId",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "",
                        "        if event['RequestType'] == 'Create':",
                        "            storePassword(physicalResourceId, event['ResourceProperties']['Password'])",
                        "            print 'The store parameter has been created. Id='+physicalResourceId",
                        "            response = { 'SsmId': physicalResourceId }",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, response, physicalResourceId)",
                        "",
                        "    except client.exceptions.ParameterNotFound:",
                        "        print 'Item already removed'",
                        "        return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "    except Exception as E:",
                        "        print E",
                        "        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                     ]
                  ]
               }
            },
            "Runtime": "python2.7",
            "Handler": "index.lambda_handler",
            "Role": {
               "Fn::GetAtt": [
                  "LambdaDeployRole",
                  "Arn"
               ]
            }
         },
         "Condition": "EULACondition"
      },
      "DeletePasswordLambda": {
         "Type": "AWS::Lambda::Function",
         "Properties": {
            "Description": "Delete password from parameter store",
            "Code": {
               "ZipFile": {
                  "Fn::Join": [
                     "\n", [
                        "import uuid",
                        "import boto3",
                        "import cfnresponse",
                        "",
                        "def deletePassword(name):",
                        "    ssmClient = boto3.client('ssm')",
                        "    return ssmClient.delete_parameter(",
                        "        Name = name",
                        "    )",
                        "",
                        "def lambda_handler(event, context):",
                        "",
                        "    physicalResourceId = str(uuid.uuid4())",
                        "    if 'PhysicalResourceId' in event:",
                        "        physicalResourceId = event['PhysicalResourceId']",
                        "    ",
                        "    try:",
                        "        if event['RequestType'] == 'Create':",
                        "            deletePassword(event['ResourceProperties']['key'])",
                        "            print 'Password succesfully deleted. Id='+event['ResourceProperties']['key']",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "        if event['RequestType'] == 'Delete':",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "",
                        "    except client.exceptions.ParameterNotFound:",
                        "        print 'Item already removed'",
                        "        return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "    except Exception as E:",
                        "        print E",
                        "        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                     ]
                  ]
               }
            },
            "Runtime": "python2.7",
            "Handler": "index.lambda_handler",
            "Role": {
               "Fn::GetAtt": [
                  "LambdaDeployRole",
                  "Arn"
               ]
            }
         },
         "Condition": "EULACondition"
      },
      "CopyfileFromBucketLambda": {
         "Type": "AWS::Lambda::Function",
         "Properties": {
            "Description": "Copy files from foreign region to local region",
            "Code": {
               "ZipFile": {
                  "Fn::Join": [
                     "\n", [
                        "import uuid",
                        "import boto3",
                        "import cfnresponse",
                        "",
                        "def CopyFileFromBucketToBucket(bucket, fileKey, destination, destBucket):",
                        "    s3Client = boto3.client('s3')",
                        "    copy_source = {'Bucket': bucket,'Key': fileKey}",
                        "    s3Client.copy_object(CopySource=copy_source, Bucket=destBucket, Key=destination)",
                        "",
                        "def DeleteObjectFromBucket(bucket, key):",
                        "    s3Client = boto3.client('s3')",
                        "    s3Client.delete_object(Bucket=bucket, Key=key)",
                        "",
                        "def lambda_handler(event, context):",
                        "",
                        "    physicalResourceId = str(uuid.uuid4())",
                        "    if 'PhysicalResourceId' in event:",
                        "        physicalResourceId = event['PhysicalResourceId']",
                        "",
                        "    try:",
                        "        if event['RequestType'] == 'Delete':",
                        "            DeleteObjectFromBucket(event['ResourceProperties']['DestBucket'], event['ResourceProperties']['FileKey'])",
                        "            print 'Object Deleted Successfully'",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "",
                        "        if event['RequestType'] == 'Create':",
                        "            CopyFileFromBucketToBucket(event['ResourceProperties']['BucketName'],event['ResourceProperties']['FileKey'],event['ResourceProperties']['FileName'],event['ResourceProperties']['DestBucket'])",
                        "            print 'file copied successfully'",
                        "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                        "",
                        "    except Exception as E:",
                        "        print E",
                        "        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                     ]
                  ]
               }
            },
            "Runtime": "python2.7",
            "Handler": "index.lambda_handler",
            "Role": {
               "Fn::GetAtt": [
                  "LambdaDeployRole",
                  "Arn"
               ]
            }
         }
      },
      "StoreMasterPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "StorePasswordLambda",
                  "Arn"
               ]
            },
            "Password": {
               "Ref": "VaultMasterPassword"
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole"
         ]
      },
      "StoreAdminPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "StorePasswordLambda",
                  "Arn"
               ]
            },
            "Password": {
               "Ref": "VaultAdminPassword"
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole"
         ]
      },
      "CleanMasterPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "DeletePasswordLambda",
                  "Arn"
               ]
            },
            "key": {
               "Fn::GetAtt": [
                  "StoreMasterPassword",
                  "SsmId"
               ]
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole",
            "StorePasswordLambda",
            "VaultDRMachine"
         ]
      },
      "CleanAdminPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "DeletePasswordLambda",
                  "Arn"
               ]
            },
            "key": {
               "Fn::GetAtt": [
                  "StoreAdminPassword",
                  "SsmId"
               ]
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole",
            "StorePasswordLambda",
            "PSMPMachine"
         ]
      },
      "CleanDRPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "DeletePasswordLambda",
                  "Arn"
               ]
            },
            "key": {
               "Fn::GetAtt": [
                  "StoreDRPassword",
                  "SsmId"
               ]
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole",
            "StorePasswordLambda",
            "VaultDRMachine"
         ]
      },
      "CopyLicenseToBucket": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "CopyfileFromBucketLambda",
                  "Arn"
               ]
            },
            "BucketName": {
               "Ref": "VaultFilesBucket"
            },
            "FileKey": {
               "Ref": "LicenseFile"
            },
            "FileName": {
               "Ref": "LicenseFile"
            },
            "DestBucket": {
               "Ref": "DeployBucket"
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole",
            "StorePasswordLambda"
         ]
      },
      "CopyRecpubToBucket": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Version": "1.0",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "CopyfileFromBucketLambda",
                  "Arn"
               ]
            },
            "BucketName": {
               "Ref": "VaultFilesBucket"
            },
            "FileKey": {
               "Ref": "RecoveryPublicKey"
            },
            "FileName": {
               "Ref": "RecoveryPublicKey"
            },
            "DestBucket": {
               "Ref": "DeployBucket"
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole"
         ]
      },
      "RandomStringLambdaFunction": {
         "Type": "AWS::Lambda::Function",
         "Properties": {
             "Code": {
                 "ZipFile": "const response = require(\"cfn-response\");\nconst randomString = (length, chars) => {\n    var result = '';\n    for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];\n    return result;\n}\nexports.handler = (event, context) =>{\n\n  const str = randomString(event['ResourceProperties']['Length'], '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');\n  const responseData = {RandomString: str};\n  response.send(event, context, response.SUCCESS, responseData);\n\n};\n"
             },
             "Handler": "index.handler",
             "Runtime": "nodejs8.10",
             "Role": {
                 "Fn::GetAtt": [
                     "LambdaLogDenyRole",
                     "Arn"
                 ]
             },
             "MemorySize": 128,
             "Timeout": 20
         }
      },
      "PVWASecretString": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Properties": {
            "Length": 16,
            "ServiceToken": {
               "Fn::GetAtt": [
                  "RandomStringLambdaFunction",
                  "Arn"
               ]
            }
         }
      },
      "CPMSecretString": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Properties": {
            "Length": 16,
            "ServiceToken": {
               "Fn::GetAtt": [
                  "RandomStringLambdaFunction",
                  "Arn"
               ]
            }
         }
      },
      "VaultMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Ref": "VaultInstanceName"
               }
            }],
            "SecurityGroupIds": {
               "Ref": "VaultInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "VaultInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "Vault"
               ]
            },
            "InstanceType": {
               "Ref": "VaultInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "<script>\n",
                        "cfn-init.exe -v -s ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        " -r VaultMachine",
                        " --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "cfn-signal.exe -e %ERRORLEVEL% ",
                        "  --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "  --resource VaultMachine",
                        "  --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "</script>"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "VaultInstancesProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "config": {
                  "files": {
                     "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "{",
                                 "  \"IsEnabled\" : true,",
                                 "  \"EngineConfiguration\" : {",
                                 "    \"PollInterval\" : \"00:00:05\",",
                                 "    \"Components\" : [",
                                 "    {",
                                 "      \"Id\" : \"EC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"EC2ConfigLog.txt\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"UTC\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init-cmd.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-wire.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                 "      }",
                                 "    }],",
                                 "    \"Flows\": {",
                                 "      \"Flows\": [",
                                 "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                 "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                 "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                 "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                 "      ]",
                                 "    }",
                                 "  }",
                                 "}"
                              ]
                           ]
                        }
                     },
                     "C:\\deploy.py": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "import boto3\n",
                                 "import sys\n",
                                 "import subprocess\n",
                                 "\n",
                                 "def fetchPassword(name):\n",
                                 "\tssmClient = boto3.client('ssm', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\tobjectResponse = ssmClient.get_parameter(\n",
                                 "\t\tName = name,\n",
                                 "\t\tWithDecryption = True\n",
                                 "\t)\n",
                                 "\treturn objectResponse['Parameter']['Value']\n",
                                 "\n",
                                 "def downloadFile(bucket,filePath,target):\n",
                                 "\ts3Client = boto3.client('s3', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\ts3Client.download_file(\n",
                                 "\t\tBucket = bucket,\n",
                                 "\t\tKey = filePath,\n",
                                 "\t\tFilename = target\n",
                                 "\t)\n",
                                 "\treturn target\n",
                                 "\n",
                                 "masterp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreMasterPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "adminp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "drp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreDRPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "\n",
                                 "licensef = downloadFile('",
                                 {
                                    "Ref": "DeployBucket"
                                 },
                                 "','",
                                 {
                                    "Ref": "LicenseFile"
                                 },
                                 "','C:\\\\vaultLicense.xml')\n",
                                 "publickeyf = downloadFile('",
                                 {
                                    "Ref": "DeployBucket"
                                 },
                                 "','",
                                 {
                                    "Ref": "RecoveryPublicKey"
                                 },
                                 "','C:\\\\recoveryPublic.key')\n",
                                 "\n",
                                 "sys.exit(subprocess.call([",
                                 "'C:\\\\Program files (x86)\\\\PrivateArk\\\\Server\\\\CAVaultManager.exe',",
                                 "'PostInstall',",
                                 "'/AdminPass',",
                                 "adminp,",
                                 "'/MasterPass',",
                                 "masterp,",
                                 "'/RecPub',",
                                 "publickeyf,",
                                 "'/IsPrimaryOrDR',",
                                 "'Primary',",
                                 "'/PrimaryVaultIP',",
                                 "'1.1.1.1',",
                                 "'/DRPassword',",
                                 "drp,",
                                 "'/EnableFailOver',",
                                 "'/LicensePath',",
                                 "licensef,",
                                 "'/AcceptEULA',",
                                 "'yes',",
                                 "'/CloudRegion','",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 "','/CloudVendor',",
                                 "'AWS'",
                                 "]))\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "windows": {
                        "AmazonSSMAgent": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json"
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-restartSSM": {
                        "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                        "waitAfterCompletion": "30",
                        "ignoreErrors": "true"
                     },
                     "02-deploy": {
                        "command": "C:\\Python27\\python.exe C:\\deploy.py",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "03-CheckVaultServiceStatus": {
                        "command": "powershell.exe -Command \" if ((Get-Service 'PrivateArk Server').Status -eq 'Running') {exit 0} else {exit 1} \"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "cfn-signal.exe -e %ERRORLEVEL% ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource VaultMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT15M"
            }
         },
         "DependsOn": [
            "CopyLicenseToBucket",
            "CopyRecpubToBucket"
         ],
         "DeletionPolicy": "Retain"
      },
      "VaultDRMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Fn::Join": [
                     " ", [{
                           "Ref": "VaultInstanceName"
                        },
                        "DR"
                     ]
                  ]
               }
            }],
            "SecurityGroupIds": {
               "Ref": "VaultInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "DRInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "Vault"
               ]
            },
            "InstanceType": {
               "Ref": "VaultInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "<script>\n",
                        "cfn-init.exe -v -s ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        " -r VaultDRMachine",
                        " --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "cfn-signal.exe -e %ERRORLEVEL% ",
                        "  --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "  --resource VaultDRMachine",
                        "  --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "</script>"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "VaultInstancesProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "config": {
                  "files": {
                     "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "{",
                                 "  \"IsEnabled\" : true,",
                                 "  \"EngineConfiguration\" : {",
                                 "    \"PollInterval\" : \"00:00:05\",",
                                 "    \"Components\" : [",
                                 "    {",
                                 "      \"Id\" : \"EC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"EC2ConfigLog.txt\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"UTC\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init-cmd.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-wire.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                 "      }",
                                 "    }],",
                                 "    \"Flows\": {",
                                 "      \"Flows\": [",
                                 "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                 "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                 "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                 "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                 "      ]",
                                 "    }",
                                 "  }",
                                 "}"
                              ]
                           ]
                        }
                     },
                     "C:\\deploy.py": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "import boto3\n",
                                 "import sys\n",
                                 "import subprocess\n",
                                 "\n",
                                 "def fetchPassword(name):\n",
                                 "\tssmClient = boto3.client('ssm', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\tobjectResponse = ssmClient.get_parameter(\n",
                                 "\t\tName = name,\n",
                                 "\t\tWithDecryption = True\n",
                                 "\t)\n",
                                 "\treturn objectResponse['Parameter']['Value']\n",
                                 "\n",
                                 "def downloadFile(bucket,filePath,target):\n",
                                 "\ts3Client = boto3.client('s3', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\ts3Client.download_file(\n",
                                 "\t\tBucket = bucket,\n",
                                 "\t\tKey = filePath,\n",
                                 "\t\tFilename = target\n",
                                 "\t)\n",
                                 "\treturn target\n",
                                 "\n",
                                 "masterp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreMasterPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "adminp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "drp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreDRPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "\n",
                                 "licensef = downloadFile('",
                                 {
                                    "Ref": "DeployBucket"
                                 },
                                 "','",
                                 {
                                    "Ref": "LicenseFile"
                                 },
                                 "','C:\\\\vaultLicense.xml')\n",
                                 "publickeyf = downloadFile('",
                                 {
                                    "Ref": "DeployBucket"
                                 },
                                 "','",
                                 {
                                    "Ref": "RecoveryPublicKey"
                                 },
                                 "','C:\\\\recoveryPublic.key')\n",
                                 "\n",
                                 "vaultIp = '",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 "'\n",
                                 "sys.exit(subprocess.call([",
                                 "'C:\\\\Program files (x86)\\\\PrivateArk\\\\Server\\\\CAVaultManager.exe',",
                                 "'PostInstall',",
                                 "'/AdminPass',",
                                 "adminp,",
                                 "'/MasterPass',",
                                 "masterp,",
                                 "'/RecPub',",
                                 "publickeyf,",
                                 "'/IsPrimaryOrDR',",
                                 "'DR',",
                                 "'/PrimaryVaultIP',",
                                 "vaultIp,",
                                 "'/DRPassword',",
                                 "drp,",
                                 "'/EnableFailOver',",
                                 "'/LicensePath',",
                                 "licensef,",
                                 "'/AcceptEULA',",
                                 "'yes',",
                                 "'/CloudRegion','",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 "','/CloudVendor',",
                                 "'AWS'",
                                 "]))\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "windows": {
                        "AmazonSSMAgent": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json"
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-restartSSM": {
                        "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                        "waitAfterCompletion": "30",
                        "ignoreErrors": "true"
                     },
                     "02-deploy": {
                        "command": "C:\\Python27\\python.exe C:\\deploy.py",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "03-CheckVaultServiceStatus": {
                        "command": "powershell.exe -Command \" if ((Get-Service 'PrivateArk Server').Status -eq 'Stopped') {exit 0} else {exit 1} \"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "04-CheckDRServiceStatus": {
                        "command": "powershell.exe -Command \" if ((Get-Service 'CyberArk Vault Disaster Recovery').Status -eq 'Running') {exit 0} else {exit 1} \"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "cfn-signal.exe -e %ERRORLEVEL% ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource VaultDRMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT15M"
            }
         },
         "DeletionPolicy": "Retain"
      },
      "StoreDRPassword": {
         "Type": "AWS::CloudFormation::CustomResource",
         "Properties": {
            "ServiceToken": {
               "Fn::GetAtt": [
                  "StorePasswordLambda",
                  "Arn"
               ]
            },
            "Password": {
               "Ref": "VaultDRPassword"
            }
         },
         "Condition": "EULACondition",
         "DependsOn": [
            "LambdaDeployRole"
         ]
      },
      "VaultInstancesProfile": {
         "Type": "AWS::IAM::InstanceProfile",
         "Properties": {
            "Path": "/",
            "Roles": [{
               "Ref": "VaultInstancesRole"
            }]
         },
         "Condition": "EULACondition",
         "DeletionPolicy": "Retain"
      },
      "ComponentInstanceProfile": {
         "Type": "AWS::IAM::InstanceProfile",
         "Properties": {
            "Roles": [{
               "Ref": "ComponentInstanceRole"
            }]
         },
         "Condition": "EULACondition",
         "DeletionPolicy": "Retain"
      },
      "ComponentInstanceRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [
                        "ec2.amazonaws.com"
                     ]
                  },
                  "Action": [
                     "sts:AssumeRole"
                  ]
               }]
            },
            "Path": "/",
            "ManagedPolicyArns": [{
               "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
            }],
            "Policies": [{
               "PolicyName": "LogRolePolicy",
               "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [{
                     "Effect": "Allow",
                     "Action": [
                        "logs:CreateLogGroup",
                        "logs:CreateLogStream",
                        "logs:PutLogEvents",
                        "logs:DescribeLogStreams"
                     ],
                     "Resource": [{
                        "Fn::Sub": "arn:${AWS::Partition}:logs:*:*:*"
                     }]
                  }]
               }
            }]
         },
         "Condition": "EULACondition",
         "DeletionPolicy": "Retain"
      },
      "PVWAMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Ref": "PVWAInstanceName"
               }
            }],
            "SecurityGroupIds": {
               "Ref": "PVWAInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "PVWAInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "PVWA"
               ]
            },
            "InstanceType": {
               "Ref": "PVWAInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "<script>\n",
                        "cfn-init.exe -v -s ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        " -r PVWAMachine",
                        " --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "cfn-signal.exe -e %ERRORLEVEL% ",
                        "  --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "  --resource PVWAMachine",
                        "  --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "</script>"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "ComponentInstanceProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "config": {
                  "files": {
                     "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "{",
                                 "  \"IsEnabled\" : true,",
                                 "  \"EngineConfiguration\" : {",
                                 "    \"PollInterval\" : \"00:00:05\",",
                                 "    \"Components\" : [",
                                 "    {",
                                 "      \"Id\" : \"EC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"EC2ConfigLog.txt\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"UTC\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init-cmd.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-wire.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                 "      }",
                                 "    }],",
                                 "    \"Flows\": {",
                                 "      \"Flows\": [",
                                 "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                 "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                 "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                 "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                 "      ]",
                                 "    }",
                                 "  }",
                                 "}"
                              ]
                           ]
                        }
                     },
                     "C:\\Set-LocalAccountPassword.ps1": {
                        "content": {
                            "Fn::Join": [
                                "", [
                                    "[CmdletBinding()]\n",
                                    "Param(\n",
                                    "  [Parameter(Mandatory=$true)][string]$Username,\n",
                                    "  [Parameter(Mandatory=$true)][string]$Password\n",
                                    ")\n",
                                    "$adsi = [ADSI]\"WinNT://$env:COMPUTERNAME\"\n",
                                    "$existing = $adsi.Children | where {$_.SchemaClassName -eq 'user' -and $_.Name -eq $Username }\n",
                                    "if ($existing -eq $null) {\n",
                                    "    Write-Error \"User $Username does not exist\"\n",
                                    "    return\n",
                                    "}\n",
                                    "$existing.SetPassword($Password)"
                                ]
                            ]
                        }
                     },
                     "C:\\Set-ServiceLogon.ps1": {
                        "content": {
                            "Fn::Join": [
                                "", [
                                    "[CmdletBinding()]\n",
                                    "Param(\n",
                                    "  [Parameter(Mandatory=$true)][string]$Service,\n",
                                    "  [Parameter(Mandatory=$true)][string]$Password\n",
                                    ")\n",
                                    "$filter = 'Name=' + \"'\" + $Service + \"'\" + ''\n",
                                    "$s = Get-WMIObject -class Win32_Service -Filter $filter\n",
                                    "$s.Change($Null,$Null,$Null,$Null,$Null,$Null,$Null,$Password,$Null,$Null,$Null)\n"
                                ]
                            ]
                        }
                     },
                     "C:\\deploy.py": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "import boto3\n",
                                 "import sys\n",
                                 "import subprocess\n",
                                 "import urllib2\n",
                                 "\n",
                                 "def fetchPassword(name):\n",
                                 "\tssmClient = boto3.client('ssm', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\tobjectResponse = ssmClient.get_parameter(\n",
                                 "\t\tName = name,\n",
                                 "\t\tWithDecryption = True\n",
                                 "\t)\n",
                                 "\treturn objectResponse['Parameter']['Value']\n",
                                 "\n",
                                 "adminp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "\n",
                                 "callArray = [",
                                 "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                 "'PVWA',",
                                 "'/accepteula',",
                                 "'Yes',",
                                 "'/vaultip',",
                                 "'",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 ",",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultDRMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 "',",
                                 "'/vaultport',",
                                 "'1858',",
                                 "'/vaultuser',",
                                 "'Administrator',",
                                 "'/vaultpassword',",
                                 "adminp",
                                 "]\n",
                                 "inputHostname='",
                                 {"Ref":"PVWAHostName"},
                                 "'\n",
                                 "if not inputHostname:\n",
                                 "\thostname = urllib2.urlopen('http://169.254.169.254/latest/meta-data/hostname').read()\n",
                                 "\tcallArray.append('/pvwaurl')\n",
                                 "\tcallArray.append('https://{0}/PasswordVault'.format(hostname))\n",
                                 "else:\n",
                                 "\tcallArray.append('/pvwaurl')\n",
                                 "\tcallArray.append('https://{0}/PasswordVault'.format(inputHostname))\n",
                                 "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "windows": {
                        "AmazonSSMAgent": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json"
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-restartSSM": {
                        "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                        "waitAfterCompletion": "30",
                        "ignoreErrors": "true"
                     },
                     "02-deploy": {
                        "command": "C:\\Python27\\python.exe C:\\deploy.py",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "03-startAppPool": {
                        "command": "powershell -command \"& {&'Import-Module' WebAdministration}\"; \"& {&'Start-WebAppPool' -Name PasswordVaultWebAccessPool}\"; \"& {&'Set-ItemProperty' -Path IIS:\\AppPools\\PasswordVaultWebAccessPool -Name autoStart -Value 'true'}\"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "04-configurePVWAUser": {
                        "command": {
                           "Fn::Join": [
                               "",
                               [
                                   "powershell.exe -File C:\\Set-LocalAccountPassword.ps1 -Username \"PVWAReportsUser\" -Password \"", { "Fn::GetAtt": ["PVWASecretString", "RandomString"] } , "\""
                               ]
                           ]
                        },
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "05-configurePVWAService": {
                        "command": {
                           "Fn::Join": [
                               "",
                               [
                                   "powershell.exe -File C:\\Set-ServiceLogon.ps1 -Service \"CyberArk Scheduled Tasks\" -Password \"", { "Fn::GetAtt": ["PVWASecretString", "RandomString"] } , "\""
                               ]
                           ]
                        },
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "06-CSTserviceConfig": {
                        "command": "sc config \"CyberArk Scheduled Tasks\" start=auto",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "07-CSTserviceStart": {
                        "command": "sc start \"CyberArk Scheduled Tasks\"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "cfn-signal.exe -e %ERRORLEVEL% ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource PVWAMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT15M"
            }
         },
         "DeletionPolicy": "Retain"
      },
      "CPMMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Ref": "CPMInstanceName"
               }
            }],
            "SecurityGroupIds": {
               "Ref": "CPMInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "CPMInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "CPM"
               ]
            },
            "InstanceType": {
               "Ref": "CPMInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "<script>\n",
                        "cfn-init.exe -v -s ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        " -r CPMMachine",
                        " --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "cfn-signal.exe -e %ERRORLEVEL% ",
                        "  --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "  --resource CPMMachine",
                        "  --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "</script>"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "ComponentInstanceProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "config": {
                  "files": {
                     "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "{",
                                 "  \"IsEnabled\" : true,",
                                 "  \"EngineConfiguration\" : {",
                                 "    \"PollInterval\" : \"00:00:05\",",
                                 "    \"Components\" : [",
                                 "    {",
                                 "      \"Id\" : \"EC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"EC2ConfigLog.txt\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"UTC\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init-cmd.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-wire.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                 "      }",
                                 "    }],",
                                 "    \"Flows\": {",
                                 "      \"Flows\": [",
                                 "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                 "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                 "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                 "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                 "      ]",
                                 "    }",
                                 "  }",
                                 "}"
                              ]
                           ]
                        }
                     },
                     "C:\\Set-LocalAccountPassword.ps1": {
                        "content": {
                            "Fn::Join": [
                                "", [
                                    "[CmdletBinding()]\n",
                                    "Param(\n",
                                    "  [Parameter(Mandatory=$true)][string]$Username,\n",
                                    "  [Parameter(Mandatory=$true)][string]$Password\n",
                                    ")\n",
                                    "$adsi = [ADSI]\"WinNT://$env:COMPUTERNAME\"\n",
                                    "$existing = $adsi.Children | where {$_.SchemaClassName -eq 'user' -and $_.Name -eq $Username }\n",
                                    "if ($existing -eq $null) {\n",
                                    "    Write-Error \"User $Username does not exist\"\n",
                                    "    return\n",
                                    "}\n",
                                    "$existing.SetPassword($Password)"
                                ]
                            ]
                        }
                     },
                     "C:\\Set-ServiceLogon.ps1": {
                        "content": {
                            "Fn::Join": [
                                "", [
                                    "[CmdletBinding()]\n",
                                    "Param(\n",
                                    "  [Parameter(Mandatory=$true)][string]$Service,\n",
                                    "  [Parameter(Mandatory=$true)][string]$Password\n",
                                    ")\n",
                                    "$filter = 'Name=' + \"'\" + $Service + \"'\" + ''\n",
                                    "$s = Get-WMIObject -class Win32_Service -Filter $filter\n",
                                    "$s.Change($Null,$Null,$Null,$Null,$Null,$Null,$Null,$Password,$Null,$Null,$Null)\n"
                                ]
                            ]
                        }
                     },
                     "C:\\deploy.py": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "import boto3\n",
                                 "import sys\n",
                                 "import subprocess\n",
                                 "\n",
                                 "def fetchPassword(name):\n",
                                 "\tssmClient = boto3.client('ssm', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\tobjectResponse = ssmClient.get_parameter(\n",
                                 "\t\tName = name,\n",
                                 "\t\tWithDecryption = True\n",
                                 "\t)\n",
                                 "\treturn objectResponse['Parameter']['Value']\n",
                                 "\n",
                                 "adminp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "\n",
                                 "callArray = [",
                                 "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                 "'CPM',",
                                 "'/accepteula',",
                                 "'Yes',",
                                 "'/vaultip',",
                                 "'",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 ",",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultDRMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 "',",
                                 "'/vaultport',",
                                 "'1858',",
                                 "'/vaultuser',",
                                 "'Administrator',",
                                 "'/vaultpassword',",
                                 "adminp",
                                 "]\n",
                                 "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "windows": {
                        "AmazonSSMAgent": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json"
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-restartSSM": {
                        "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                        "waitAfterCompletion": "30",
                        "ignoreErrors": "true"
                     },
                     "02-deploy": {
                        "command": "C:\\Python27\\python.exe C:\\deploy.py",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "03-configureCPMUser": {
                        "command": {
                           "Fn::Join": [
                               "",
                               [
                                   "powershell.exe -File C:\\Set-LocalAccountPassword.ps1 -Username \"PasswordManagerUser\" -Password \"", { "Fn::GetAtt": ["CPMSecretString", "RandomString"] } , "\""
                               ]
                           ]
                        },
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "04-configureCPMService": {
                        "command": {
                           "Fn::Join": [
                               "",
                               [
                                   "powershell.exe -File C:\\Set-ServiceLogon.ps1 -Service \"CyberArk Password Manager\" -Password \"", { "Fn::GetAtt": ["CPMSecretString", "RandomString"] } , "\""
                               ]
                           ]
                        },
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "05-configureCPMScannerService": {
                        "command": {
                           "Fn::Join": [
                               "",
                               [
                                   "powershell.exe -File C:\\Set-ServiceLogon.ps1 -Service \"CyberArk Central Policy Manager Scanner\" -Password \"", { "Fn::GetAtt": ["CPMSecretString", "RandomString"] } , "\""
                               ]
                           ]
                        },
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "06-CPMserviceConfig": {
                        "command": "sc config \"CyberArk Password Manager\" start=auto",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "07-CPMSserviceConfig": {
                        "command": "sc config \"CyberArk Central Policy Manager Scanner\" start=auto",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "08-CPMserviceStart": {
                        "command": "sc start \"CyberArk Password Manager\"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "09-CPMSserviceStart": {
                        "command": "sc start \"CyberArk Central Policy Manager Scanner\"",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "cfn-signal.exe -e %ERRORLEVEL% ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource CPMMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "DependsOn": [
            "PVWAMachine"
         ],
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT15M"
            }
         },
         "DeletionPolicy": "Retain"
      },
      "PSMMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Ref": "PSMInstanceName"
               }
            }],
            "SecurityGroupIds": {
               "Ref": "PSMInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "PSMInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "PSM"
               ]
            },
            "InstanceType": {
               "Ref": "PSMInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "<script>\n",
                        "cfn-init.exe -v -s ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        " -r PSMMachine",
                        " --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "cfn-signal.exe -e %ERRORLEVEL% ",
                        "  --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "  --resource PSMMachine",
                        "  --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "</script>"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "ComponentInstanceProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "config": {
                  "files": {
                     "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "{",
                                 "  \"IsEnabled\" : true,",
                                 "  \"EngineConfiguration\" : {",
                                 "    \"PollInterval\" : \"00:00:05\",",
                                 "    \"Components\" : [",
                                 "    {",
                                 "      \"Id\" : \"EC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"EC2ConfigLog.txt\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"UTC\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-init-cmd.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                 "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                 "        \"Encoding\": \"ASCII\",",
                                 "        \"Filter\": \"cfn-wire.log\",",
                                 "        \"CultureName\": \"en-US\",",
                                 "        \"TimeZoneKind\": \"Local\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                 "      }",
                                 "    },",
                                 "    {",
                                 "      \"Id\": \"CloudWatchCfnWireLog\",",
                                 "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                 "      \"Parameters\": {",
                                 "        \"AccessKey\": \"\",",
                                 "        \"SecretKey\": \"\",",
                                 {
                                    "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                 },
                                 {
                                    "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                 },
                                 "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                 "      }",
                                 "    }],",
                                 "    \"Flows\": {",
                                 "      \"Flows\": [",
                                 "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                 "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                 "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                 "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                 "      ]",
                                 "    }",
                                 "  }",
                                 "}"
                              ]
                           ]
                        }
                     },
                     "C:\\deploy.py": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "import boto3\n",
                                 "import sys\n",
                                 "import subprocess\n",
                                 "import urllib2\n",
                                 "\n",
                                 "def fetchPassword(name):\n",
                                 "\tssmClient = boto3.client('ssm', region_name='",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "')\n",
                                 "\tobjectResponse = ssmClient.get_parameter(\n",
                                 "\t\tName = name,\n",
                                 "\t\tWithDecryption = True\n",
                                 "\t)\n",
                                 "\treturn objectResponse['Parameter']['Value']\n",
                                 "\n",
                                 "adminp = fetchPassword('",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 "')\n",
                                 "\n",
                                 "callArray = [",
                                 "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                 "'PSM',",
                                 "'/accepteula',",
                                 "'Yes',",
                                 "'/vaultip',",
                                 "'",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 ",",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultDRMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 "',",
                                 "'/vaultport',",
                                 "'1858',",
                                 "'/vaultuser',",
                                 "'Administrator',",
                                 "'/vaultpassword',",
                                 "adminp",
                                 "]\n",
                                 "properties = urllib2.urlopen('http://169.254.169.254/latest/meta-data').read()\n",
                                 "if 'public-ipv4' in properties:\n",
                                 "\tipv4 = urllib2.urlopen('http://169.254.169.254/latest/meta-data/public-ipv4').read()\n",
                                 "\tif ipv4 and ipv4 <> 'none':\n",
                                 "\t\tcallArray.append('/psmpublicip')\n",
                                 "\t\tcallArray.append(ipv4)\n",
                                 "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "windows": {
                        "AmazonSSMAgent": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json"
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-restartSSM": {
                        "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                        "waitAfterCompletion": "30",
                        "ignoreErrors": "true"
                     },
                     "02-deploy": {
                        "command": "C:\\Python27\\python.exe C:\\deploy.py",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "03-PSMserviceConfig": {
                        "command": "sc config \"Cyber-Ark Privileged Session Manager\" start=auto",
                        "waitAfterCompletion": "0",
                        "ignoreErrors": "false"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "cfn-signal.exe -e %ERRORLEVEL% ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource PSMMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "DependsOn": [
            "CPMMachine"
         ],
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT15M"
            }
         },
         "DeletionPolicy": "Retain"
      },
      "PSMPMachine": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "Tags": [{
               "Key": "Name",
               "Value": {
                  "Ref": "PSMPInstanceName"
               }
            }],
            "SecurityGroupIds": {
               "Ref": "PSMPInstanceSecurityGroups"
            },
            "SubnetId": {
               "Ref": "PSMPInstanceSubnetId"
            },
            "ImageId": {
               "Fn::FindInMap": [
                  "RegionMap",
                  {
                     "Ref": "AWS::Region"
                  },
                  "PSMP"
               ]
            },
            "InstanceType": {
               "Ref": "PSMPInstanceType"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "", [
                        "#!/bin/bash -e\n",
                        "/opt/aws/bin/cfn-init -v ",
                        "         --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "         --resource PSMPMachine ",
                        "         --configsets install_all ",
                        "         --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n",
                        "/opt/aws/bin/cfn-signal -e $? ",
                        "         --stack ",
                        {
                           "Ref": "AWS::StackId"
                        },
                        "         --resource PSMPMachine ",
                        "         --region ",
                        {
                           "Ref": "AWS::Region"
                        },
                        "\n"
                     ]
                  ]
               }
            },
            "KeyName": {
               "Ref": "KeyName"
            },
            "IamInstanceProfile": {
               "Ref": "ComponentInstanceProfile"
            }
         },
         "Metadata": {
            "AWS::CloudFormation::Init": {
               "configSets": {
                  "install_all": [
                     "install_cfn",
                     "install_logs",
                     "install_psmp"
                  ]
               },
               "install_cfn": {
                  "files": {
                     "/etc/cfn/cfn-hup.conf": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "[main]\n",
                                 "stack=",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "\n",
                                 "region=",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "\n"
                              ]
                           ]
                        },
                        "mode": "000400",
                        "owner": "root",
                        "group": "root"
                     },
                     "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "[cfn-auto-reloader-hook]\n",
                                 "triggers=post.update\n",
                                 "path=Resources.PSMPMachine.Metadata.AWS::CloudFormation::Init\n",
                                 "action=/opt/aws/bin/cfn-init -v ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackName"
                                 },
                                 "         --resource PSMPMachine ",
                                 "         --configsets install_all ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "\n",
                                 "runas=root\n"
                              ]
                           ]
                        }
                     }
                  },
                  "services": {
                     "sysvinit": {
                        "cfn-hup": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "/etc/cfn/cfn-hup.conf",
                              "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                           ]
                        }
                     }
                  }
               },
               "install_logs": {
                  "files": {
                     "/etc/awslogs/awslogs.conf": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "[general]\n",
                                 "state_file= /var/awslogs/state/agent-state\n",
                                 "[/var/log/cloud-init.log]\n",
                                 "file = /var/log/cloud-init.log\n",
                                 "log_group_name = ",
                                 {
                                    "Ref": "LogGroup"
                                 },
                                 "\n",
                                 "log_stream_name = {instance_id}/cloud-init.log\n",
                                 "datetime_format = \n",
                                 "[/var/log/cloud-init-output.log]\n",
                                 "file = /var/log/cloud-init-output.log\n",
                                 "log_group_name = ",
                                 {
                                    "Ref": "LogGroup"
                                 },
                                 "\n",
                                 "log_stream_name = {instance_id}/cloud-init-output.log\n",
                                 "datetime_format = \n",
                                 "[/var/log/cfn-init.log]\n",
                                 "file = /var/log/cfn-init.log\n",
                                 "log_group_name = ",
                                 {
                                    "Ref": "LogGroup"
                                 },
                                 "\n",
                                 "log_stream_name = {instance_id}/cfn-init.log\n",
                                 "datetime_format = \n",
                                 "[/var/log/cfn-hup.log]\n",
                                 "file = /var/log/cfn-hup.log\n",
                                 "log_group_name = ",
                                 {
                                    "Ref": "LogGroup"
                                 },
                                 "\n",
                                 "log_stream_name = {instance_id}/cfn-hup.log\n",
                                 "datetime_format = \n",
                                 "[/var/log/cfn-wire.log]\n",
                                 "file = /var/log/cfn-wire.log\n",
                                 "log_group_name = ",
                                 {
                                    "Ref": "LogGroup"
                                 },
                                 "\n",
                                 "log_stream_name = {instance_id}/cfn-wire.log\n",
                                 "datetime_format = \n"
                              ]
                           ]
                        },
                        "mode": "000444",
                        "owner": "root",
                        "group": "root"
                     },
                     "/etc/awslogs/awscli.conf": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "[plugins]\n",
                                 "cwlogs = cwlogs\n",
                                 "[default]\n",
                                 "region = ",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 "\n"
                              ]
                           ]
                        },
                        "mode": "000444",
                        "owner": "root",
                        "group": "root"
                     }
                  },
                  "commands": {
                     "01_create_state_directory": {
                        "command": "mkdir -p /var/awslogs/state"
                     }
                  },
                  "services": {
                     "sysvinit": {
                        "awslogs": {
                           "enabled": "true",
                           "ensureRunning": "true",
                           "files": [
                              "/etc/awslogs/awslogs.conf"
                           ]
                        }
                     }
                  }
               },
               "install_psmp": {
                  "files": {
                     "/root/CD-Image/activatePSMP": {
                        "content": {
                           "Fn::Join": [
                              "", [
                                 "#!/bin/bash -e\n",
                                 "chmod 700 /root/CD-Image/register_and_activation.sh\n",
                                 "temppassword=`aws ssm get-parameter --name ",
                                 {
                                    "Fn::GetAtt": [
                                       "StoreAdminPassword",
                                       "SsmId"
                                    ]
                                 },
                                 " --region=",
                                 {
                                    "Ref": "AWS::Region"
                                 },
                                 " --with-decryption --output text --query Parameter.Value`\n",
                                 "echo Object successfully retrieved from ssm.\n",
                                 "/opt/CARKpsmp/bin/createcredfile /root/CD-Image/user.cred Password -Username Administrator -Password $temppassword -Hostname\n",
                                 "echo Credentials file successfully created.\n",
                                 "/root/CD-Image/register_and_activation.sh /root/CD-Image/user.cred ",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 ",",
                                 {
                                    "Fn::GetAtt": [
                                       "VaultDRMachine",
                                       "PrivateIp"
                                    ]
                                 },
                                 " $(curl http://169.254.169.254/latest/meta-data/instance-id) y\n"
                              ]
                           ]
                        }
                     }
                  },
                  "commands": {
                     "01-Chmod": {
                        "command": "sudo chmod 700 /root/CD-Image/activatePSMP"
                     },
                     "02-PSMPdeploy": {
                        "command": "sudo /root/CD-Image/activatePSMP"
                     },
                     "03-ClearData": {
                        "command": "sudo shred -u /root/CD-Image/activatePSMP"
                     },
                     "04-RemoveInstallationFolder": {
                        "command": "sudo rm -rf /root/CD-Image"
                     },
                     "99-SignalCompletion": {
                        "command": {
                           "Fn::Join": [
                              "", [
                                 "/opt/aws/bin/cfn-signal -e $? ",
                                 "         --stack ",
                                 {
                                    "Ref": "AWS::StackId"
                                 },
                                 "         --resource PSMPMachine ",
                                 "         --region ",
                                 {
                                    "Ref": "AWS::Region"
                                 }
                              ]
                           ]
                        }
                     }
                  }
               }
            }
         },
         "DependsOn": [
            "PSMMachine"
         ],
         "CreationPolicy": {
            "ResourceSignal": {
               "Timeout": "PT10M"
            }
         },
         "DeletionPolicy": "Retain"
      },
      "VaultInstancesRole": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [
                        "ec2.amazonaws.com"
                     ]
                  },
                  "Action": [
                     "sts:AssumeRole"
                  ]
               }]
            },
            "Path": "/",
            "ManagedPolicyArns": [{
               "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
            }],
            "Policies": [{
               "PolicyName": "LogRolePolicy",
               "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [{
                     "Effect": "Allow",
                     "Action": [
                        "logs:CreateLogGroup",
                        "logs:CreateLogStream",
                        "logs:PutLogEvents",
                        "logs:DescribeLogStreams"
                     ],
                     "Resource": [{
                        "Fn::Sub": "arn:${AWS::Partition}:logs:*:*:*"
                     }]
                  }]
               }
            }]
         },
         "Condition": "EULACondition",
         "DeletionPolicy": "Retain"
      },
      "InstancesSSMPolicy": {
         "Type": "AWS::IAM::Policy",
         "Properties": {
            "PolicyName": "InstancesSsmAccess",
            "PolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Action": [
                     "ssm:GetParameter"
                  ],
                  "Resource": [{
                     "Fn::Sub": "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"
                  }]
               }]
            },
            "Roles": [{
                  "Ref": "ComponentInstanceRole"
               },
               {
                  "Ref": "VaultInstancesRole"
               }
            ]
         },
         "Condition": "EULACondition"
      },
      "VaultInstancesKMSPolicy": {
         "Type": "AWS::IAM::Policy",
         "Properties": {
            "PolicyName": "VaultInstancesKMSAccess",
            "PolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Action": [
                     "kms:Encrypt",
                     "kms:Decrypt"
                  ],
                  "Resource": "*"
               }]
            },
            "Roles": [{
               "Ref": "VaultInstancesRole"
            }]
         },
         "Condition": "EULACondition",
         "DeletionPolicy": "Retain"
      },
      "VaultInstancesS3VaultFilesBucketPolicy": {
         "Type": "AWS::IAM::Policy",
         "Properties": {
            "PolicyName": "VaultFilesBucketAccess",
            "PolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Action": [
                     "s3:GetObject",
                     "s3:GetObjectVersion"
                  ],
                  "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::${VaultFilesBucket}/*" }
               }]
            },
            "Roles": [{
               "Ref": "VaultInstancesRole"
            }]
         },
         "Condition": "EULACondition"
      },
      "VaultBootstrapKMSPolicy": {
         "Type": "AWS::IAM::Policy",
         "Properties": {
            "PolicyName": "VaultBootstrapKMSAccess",
            "PolicyDocument": {
               "Statement": [{
                  "Effect": "Allow",
                  "Action": [
                     "kms:CreateKey",
                     "kms:GenerateRandom"
                  ],
                  "Resource": "*"
               }]
            },
            "Roles": [{
               "Ref": "VaultInstancesRole"
            }]
         }
      }
   },
   "Parameters": {
      "EULA": {
         "Type": "String",
         "Description": "I have read and agree to the Terms and Conditions.",
         "AllowedValues": [
            "Accept",
            "Decline"
         ],
         "Default": "Decline"
      },
      "KeyName": {
         "Type": "AWS::EC2::KeyPair::KeyName",
         "Description": "Select an existing Key Pair from your AWS account.",
         "ConstraintDescription": "Can contain only ASCII characters."
      },
      "VaultFilesBucket": {
         "Type": "String",
         "Description": "Enter the name of the bucket containing the license and recovery public key."
      },
      "LicenseFile": {
         "Type": "String",
         "Description": "Enter the path of the license file within the bucket.",
         "Default": "license.xml"
      },
      "RecoveryPublicKey": {
         "Type": "String",
         "Description": "Enter the path of the recovery public key file within the bucket.",
         "Default": "recpub.key"
      },
      "VaultInstanceName": {
         "Type": "String",
         "Description": "Enter a name for the Vault instance.",
         "Default": "CyberArk Vault"
      },
      "VaultMasterPassword": {
         "Type": "String",
         "Description": "Enter a password for the Vault Master user.",
         "NoEcho": true,
         "MinLength": 8,
         "AllowedPattern": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&\\*\\(\\)_\\-+=:])(?=\\S+$).{8,}$",
         "ConstraintDescription": "Vault Master password must contain at least 1 lowercase letter, 1 uppercase letter, 1 digit and 1 special character"
      },
      "RetypeMasterPassword": {
         "Type": "String",
         "Description": "Retype the password for the Vault Master user.",
         "NoEcho": true,
         "MinLength": 8
      },
      "VaultAdminPassword": {
         "Type": "String",
         "Description": "Enter a password for the Vault Administrator user.",
         "NoEcho": true,
         "MinLength": 8,
         "AllowedPattern": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&\\*\\(\\)_\\-+=:])(?=\\S+$).{8,}$",
         "ConstraintDescription": "Vault Administrator password must contain at least 1 lowercase letter, 1 uppercase letter, 1 digit and 1 special character"
      },
      "RetypeAdminPassword": {
         "Type": "String",
         "Description": "Retype the password for the Vault Administrator user.",
         "NoEcho": true,
         "MinLength": 8
      },
      "VaultDRPassword": {
         "Type": "String",
         "Description": "Enter a password for the Vault DR user.",
         "NoEcho": true,
         "MinLength": 8,
         "AllowedPattern": "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&\\*\\(\\)_\\-+=:])(?=\\S+$).{8,}$",
         "ConstraintDescription": "Vault DR password must contain at least 1 lowercase letter, 1 uppercase letter, 1 digit and 1 special character"
      },
      "RetypeDRPassword": {
         "Type": "String",
         "Description": "Retype the password for the Vault DR user.",
         "NoEcho": true,
         "MinLength": 8
      },
      "VaultInstanceType": {
         "Type": "String",
         "Description": "Select the instance type of the Vault instance.",
         "AllowedValues": [
            "m4.large",
            "m4.xlarge",
            "m4.2xlarge",
            "m4.4xlarge"
         ],
         "Default": "m4.large"
      },
      "VaultInstanceSecurityGroups": {
         "Type": "List<AWS::EC2::SecurityGroup::Id>",
         "Description": "Assign Security Groups to the Vault and Vault DR instances."
      },
      "VaultInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the Vault instance will reside."
      },
      "DRInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the Vault DR instance will reside."
      },
      "CPMInstanceName": {
         "Type": "String",
         "Description": "Enter a name for the CPM instance.",
         "Default": "CyberArk CPM"
      },
      "CPMInstanceType": {
         "Type": "String",
         "Description": "Select the instance type of the CPM instance.",
         "AllowedValues": [
            "c4.large",
            "c4.xlarge",
            "c4.2xlarge",
            "c4.4xlarge"
         ],
         "Default": "c4.large"
      },
      "CPMInstanceSecurityGroups": {
         "Type": "List<AWS::EC2::SecurityGroup::Id>",
         "Description": "Assign Security Groups to the CPM instance."
      },
      "CPMInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the CPM instance will reside."
      },
      "PVWAInstanceName": {
         "Type": "String",
         "Description": "Enter a name for the PVWA instance.",
         "Default": "CyberArk PVWA"
      },
      "PVWAInstanceType": {
         "Type": "String",
         "Description": "Select the instance type of the PVWA instance.",
         "AllowedValues": [
            "t2.medium",
            "t2.large",
            "t2.xlarge",
            "t2.2xlarge"
         ],
         "Default": "t2.medium"
      },
      "PVWAInstanceSecurityGroups": {
         "Type": "List<AWS::EC2::SecurityGroup::Id>",
         "Description": "Assign Security Groups to the PVWA instance."
      },
      "PVWAInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the PVWA instance will reside."
      },
      "PVWAHostName":{
         "Type":"String",
         "Description":"IP or FQDN of PVWA server"
      },
      "PSMInstanceName": {
         "Type": "String",
         "Description": "Enter a name for the PSM instance.",
         "Default": "CyberArk PSM"
      },
      "PSMInstanceType": {
         "Type": "String",
         "Description": "Select the instance type of the PSM instance.",
         "AllowedValues": [
            "c4.2xlarge",
            "c4.4xlarge",
            "c4.8xlarge"
         ],
         "Default": "c4.2xlarge"
      },
      "PSMInstanceSecurityGroups": {
         "Type": "List<AWS::EC2::SecurityGroup::Id>",
         "Description": "Assign Security Groups to the PSM instance."
      },
      "PSMInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the PSM instance will reside."
      },
      "PSMPInstanceName": {
         "Type": "String",
         "Description": "Enter a name for the PSM SSH Proxy instance.",
         "Default": "CyberArk PSM SSH Proxy"
      },
      "PSMPInstanceType": {
         "Type": "String",
         "Description": "Select the instance type of the PSM SSH Proxy instance.",
         "AllowedValues": [
            "m4.large",
            "m4.xlarge",
            "m4.2xlarge",
            "m4.4xlarge"
         ],
         "Default": "m4.large"
      },
      "PSMPInstanceSecurityGroups": {
         "Type": "List<AWS::EC2::SecurityGroup::Id>",
         "Description": "Assign Security Groups to the PSM SSH Proxy instance."
      },
      "PSMPInstanceSubnetId": {
         "Type": "AWS::EC2::Subnet::Id",
         "Description": "Select the Subnet Id where the PSM SSH Proxy instance will reside."
      }
   },
   "Conditions": {
      "EULACondition": {
         "Fn::Equals": [
            "Accept",
            {
               "Ref": "EULA"
            }
         ]
      }
   },
   "Rules": {
      "PasswordConfirmation": {
         "Assertions": [{
               "Assert": {
                  "Fn::Equals": [{
                        "Ref": "VaultMasterPassword"
                     },
                     {
                        "Ref": "RetypeMasterPassword"
                     }
                  ]
               },
               "AssertDescription": "The password confirmation does not match."
            },
            {
               "Assert": {
                  "Fn::Equals": [{
                        "Ref": "VaultAdminPassword"
                     },
                     {
                        "Ref": "RetypeAdminPassword"
                     }
                  ]
               },
               "AssertDescription": "The password confirmation does not match."
            },
            {
               "Assert": {
                  "Fn::Equals": [{
                        "Ref": "VaultDRPassword"
                     },
                     {
                        "Ref": "RetypeDRPassword"
                     }
                  ]
               },
               "AssertDescription": "The password confirmation does not match."
            }
         ]
      }
   },
   "Metadata": {
      "AWS::CloudFormation::Interface": {
         "ParameterGroups": [{
               "Label": {
                  "default": "General parameters"
               },
               "Parameters": [
                  "EULA",
                  "KeyName",
                  "VaultFilesBucket",
                  "LicenseFile",
                  "RecoveryPublicKey"
               ]
            },
            {
               "Label": {
                  "default": "Vault and Vault DR configuration"
               },
               "Parameters": [
                  "VaultInstanceName",
                  "VaultMasterPassword",
                  "RetypeMasterPassword",
                  "VaultAdminPassword",
                  "RetypeAdminPassword",
                  "VaultDRPassword",
                  "RetypeDRPassword",
                  "VaultInstanceType",
                  "VaultInstanceSecurityGroups",
                  "VaultInstanceSubnetId",
                  "DRInstanceSubnetId"
               ]
            },
            {
               "Label": {
                  "default": "CPM configuration"
               },
               "Parameters": [
                  "CPMInstanceName",
                  "CPMInstanceType",
                  "CPMInstanceSecurityGroups",
                  "CPMInstanceSubnetId"
               ]
            },
            {
               "Label": {
                  "default": "PVWA configuration"
               },
               "Parameters": [
                  "PVWAInstanceName",
                  "PVWAInstanceType",
                  "PVWAInstanceSecurityGroups",
                  "PVWAInstanceSubnetId",
                  "PVWAHostName"
               ]
            },
            {
               "Label": {
                  "default": "PSM configuration"
               },
               "Parameters": [
                  "PSMInstanceName",
                  "PSMInstanceType",
                  "PSMInstanceSecurityGroups",
                  "PSMInstanceSubnetId"
               ]
            },
            {
               "Label": {
                  "default": "PSM SSH Proxy configuration"
               },
               "Parameters": [
                  "PSMPInstanceName",
                  "PSMPInstanceType",
                  "PSMPInstanceSecurityGroups",
                  "PSMPInstanceSubnetId"
               ]
            }
         ],
         "ParameterLabels": {
            "EULA": {
               "default": "License Agreement"
            },
            "KeyName": {
               "default": "Key Pair"
            },
            "VaultFilesBucket": {
               "default": "Vault Files Bucket"
            },
            "LicenseFile": {
               "default": "License File"
            },
            "RecoveryPublicKey": {
               "default": "Recovery Public Key"
            },
            "VaultInstanceName": {
               "default": "Vault Instance Name"
            },
            "VaultMasterPassword": {
               "default": "Vault Master Password"
            },
            "RetypeMasterPassword": {
               "default": "Retype Master Password"
            },
            "VaultAdminPassword": {
               "default": "Vault Admin Password"
            },
            "RetypeAdminPassword": {
               "default": "Retype Admin Password"
            },
            "VaultDRPassword": {
               "default": "DR Password"
            },
            "RetypeDRPassword": {
               "default": "Retype DR Password"
            },
            "VaultInstanceType": {
               "default": "Vault and Vault DR Instance Type"
            },
            "VaultInstanceSecurityGroups": {
               "default": "Vault Security Groups"
            },
            "VaultInstanceSubnetId": {
               "default": "Vault Instance Subnet Id"
            },
            "DRInstanceSubnetId": {
               "default": "Vault DR Instance Subnet Id"
            },
            "CPMInstanceName": {
               "default": "CPM Instance Name"
            },
            "CPMInstanceType": {
               "default": "CPM Instance Type"
            },
            "CPMInstanceSecurityGroups": {
               "default": "CPM Instance Security Groups"
            },
            "CPMInstanceSubnetId": {
               "default": "CPM Instance Subnet Id"
            },
            "PVWAInstanceName": {
               "default": "PVWA Instance Name"
            },
            "PVWAInstanceType": {
               "default": "PVWA Instance Type"
            },
            "PVWAInstanceSecurityGroups": {
               "default": "PVWA Instance Security Groups"
            },
            "PVWAInstanceSubnetId": {
               "default": "PVWA Instance Subnet Id"
            },
            "PVWAHostName":{
               "default":"PVWA FQDN (Optional)"
            },
            "PSMInstanceName": {
               "default": "PSM Instance Name"
            },
            "PSMInstanceType": {
               "default": "PSM Instance Type"
            },
            "PSMInstanceSecurityGroups": {
               "default": "PSM Instance Security Groups"
            },
            "PSMInstanceSubnetId": {
               "default": "PSM Instance Subnet Id"
            },
            "PSMPInstanceName": {
               "default": "PSM SSH Proxy Instance Name"
            },
            "PSMPInstanceType": {
               "default": "PSM SSH Proxy Instance Type"
            },
            "PSMPInstanceSecurityGroups": {
               "default": "PSM SSH Proxy Instance Security Groups"
            },
            "PSMPInstanceSubnetId": {
               "default": "PSM SSH Proxy Instance Subnet Id"
            }
         }
      }
   },
   "Mappings": {
      "RegionMap": {
         "us-east-1": {
            "Vault": "ami-0cf1c48744ffdf9db",
            "CPM": "ami-01f4a2a07b19aa6f0",
            "PVWA": "ami-05d217d7beae359b9",
            "PSM": "ami-08f6c84a58951e1cd",
            "PSMP": "ami-0fb8ac4ef13225047"
         },
         "us-east-2":{
            "Vault":"ami-0efd82b593f0b4b83",
            "CPM":"ami-00991183ac415cbed",
            "PVWA":"ami-0289fae2c2ead1a3f",
            "PSM":"ami-0bc611a654b8649be",
            "PSMP":"ami-0c20cbf0021eeddfa"
         },
         "eu-west-2": {
            "Vault": "ami-0b57d5d528387343f",
            "CPM": "ami-0a070b1fe3f976ce5",
            "PVWA": "ami-0605fddba612b20fd",
            "PSM": "ami-0534718f417ae5dac",
            "PSMP": "ami-06ff76a43e0f1e659"
         },
         "us-west-1": {
            "Vault": "ami-0da1386e3b160a55c",
            "CPM": "ami-031d438cb08e9e2a3",
            "PVWA": "ami-0b809d1da1546e6f4",
            "PSM": "ami-067ec025821bf90c8",
            "PSMP": "ami-079c6f86eaaa21956"
         },
         "us-west-2": {
            "Vault": "ami-090bcd24bb360762b",
            "CPM": "ami-0974a4fb38db9ba92",
            "PVWA": "ami-083dfac640243baf1",
            "PSM": "ami-0db48c502a164cbf5",
            "PSMP": "ami-043f98b5d1d1fa0b5"
         },
         "ca-central-1": {
            "Vault": "ami-02082f5c5bde642f0",
            "CPM": "ami-0bfbfbaf34ef50082",
            "PVWA": "ami-0d8b995c2aa494cb4",
            "PSM": "ami-02d7335e178b736cb",
            "PSMP": "ami-0ae8477d9339243f7"
         },
         "eu-west-1": {
            "Vault": "ami-06fe53288df210711",
            "CPM": "ami-06b193ca65a341cc7",
            "PVWA": "ami-0ccdc1e458ce0a0e3",
            "PSM": "ami-0de6e5f2676414c57",
            "PSMP": "ami-0de091c7e47fb5123"
         },
         "eu-central-1": {
            "Vault": "ami-06920cea77dd0ecc3",
            "CPM": "ami-0a0e99bd1043bff3b",
            "PVWA": "ami-00ddfe2f3f096d218",
            "PSM": "ami-003322631d95a16fe",
            "PSMP": "ami-0ec69297cc32195f2"
         },
         "ap-southeast-1": {
            "Vault": "ami-0ac4c40371aaf0784",
            "CPM": "ami-07792d932a87f2f4a",
            "PVWA": "ami-073b88b211b48c2c4",
            "PSM": "ami-0c2b2ddacab1d0dfc",
            "PSMP": "ami-04a54577464646bb3"
         },
         "ap-southeast-2": {
            "Vault": "ami-0f6822df95ff790ce",
            "CPM": "ami-0f8fd5f9eaff9198f",
            "PVWA": "ami-022d732d80853cd9e",
            "PSM": "ami-0da1833ead00f469f",
            "PSMP": "ami-057ba59ad2c8d2f73"
         },
         "ap-northeast-2": {
            "Vault": "ami-06827f6147908102d",
            "CPM": "ami-021f08f853d710b3a",
            "PVWA": "ami-020972572398dd6b3",
            "PSM": "ami-091e64e42f355690c",
            "PSMP": "ami-0bffe43bca05042c8"
         },
         "ap-northeast-1": {
            "Vault": "ami-0f2f5331ae23e533b",
            "CPM": "ami-0e73e5e5271302454",
            "PVWA": "ami-04ba944293de8ba20",
            "PSM": "ami-044f960feba900d98",
            "PSMP": "ami-09732d42317e4636f"
         },
         "ap-south-1": {
            "Vault": "ami-0e1dcf9eb1c5ede0a",
            "CPM": "ami-0a1d3c9d70feaa107",
            "PVWA": "ami-0dc291976629286e7",
            "PSM": "ami-050b0a6b98c9c15c5",
            "PSMP": "ami-07d62c13482f612e1"
         },
         "sa-east-1": {
            "Vault": "ami-0f913359bafc47794",
            "CPM": "ami-018a24d9e6904ef10",
            "PVWA": "ami-02f39927936fc77dd",
            "PSM": "ami-0a1613614f417f6b3",
            "PSMP": "ami-00572bcf418094156"
         },
         "us-gov-west-1": {
            "Vault": "ami-73482912",
            "CPM": "ami-835b3ae2",
            "PVWA": "ami-4d5f3e2c",
            "PSM": "ami-e4a0c185",
            "PSMP": "ami-815f3ee0"
         }
      }
   },
   "Outputs": {
      "CloudWatchLogGroupName": {
         "Description": "The name of the CloudWatch log group",
         "Value": {
            "Ref": "LogGroup"
         }
      }
   }
}