{
    "Resources": {
        "LogGroup": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "RetentionInDays": 30
            },
            "DeletionPolicy": "Retain"
        },
        "DeployBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "Private"
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "fc7df917-b0b9-4452-9aaf-e71861744c7d"
                }
            }
        },
        "DeployBucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "DeployBucket"
                },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::GetAtt": [
                                        "LambdaDeployRole",
                                        "Arn"
                                    ]
                                }
                            },
                            "Action": [
                                "s3:PutObject",
                                "s3:DeleteObject",
                                "s3:DeleteObjectVersion"
                            ],
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "DeployBucket"
                                        },
                                        "/*"
                                    ]
                                ]
                            }
                        },
                        {
                            "Sid": "DenyUnEncryptedObjectUploads",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "DeployBucket"
                                        },
                                        "/*"
                                    ]
                                ]
                            },
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "AES256"
                                }
                            }
                        },
                        {
                            "Sid": " DenyUnEncryptedInflightOperations",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:*",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "DeployBucket"
                                        },
                                        "/*"
                                    ]
                                ]
                            },
                            "Condition": {
                                "Bool": {
                                    "aws:SecureTransport": false
                                }
                            }
                        }
                    ]
                }
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e0f67985-8361-4891-b23a-860e90e37412"
                }
            }
        },
        "LambdaDeployRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudWatch",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:DescribeLogGroups",
                                        "logs:DescribeLogStreams",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "23d3a636-2b70-4f0c-8849-9e7861edb7b6"
                }
            }
        },
        "StorePasswordLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Encrypts given string and saves chipper to bucket",
                "Code": {
                    "ZipFile": {
                        "Fn::Join": [
                            "\n",
                            [
                                "import uuid",
                                "import boto3",
                                "import cfnresponse",
                                "",
                                "def createFile(bucket, file, body):",
                                "    s3Client = boto3.client('s3')",
                                "    return s3Client.put_object(",
                                "        Bucket = bucket,",
                                "        Key = file,",
                                "        ServerSideEncryption = 'AES256',",
                                "        Body = body",
                                "    )",
                                "",
                                "def deleteFile(bucket, file):",
                                "    s3Client = boto3.client('s3')",
                                "    return s3Client.delete_object(",
                                "        Bucket = bucket,",
                                "        Key = file",
                                "    )",
                                "",
                                "def lambda_handler(event, context):",
                                "",
                                "    physicalResourceId = str(uuid.uuid4())",
                                "    if 'PhysicalResourceId' in event:",
                                "        physicalResourceId = event['PhysicalResourceId']",
                                "",
                                "    for key in ['PlainText', 'BucketId']:",
                                "        if key not in event['ResourceProperties'] or not event['ResourceProperties'][key]:",
                                "            print 'The properties PlainText and BucketId must not be empty'",
                                "            return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)",
                                "",
                                "    try:",
                                "        if event['RequestType'] == 'Delete':",
                                "            deleteFile(event['ResourceProperties']['BucketId'], physicalResourceId)",
                                "            print 'The secret file deleted'",
                                "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
                                "",
                                "        if event['RequestType'] == 'Create':",
                                "            createFile(event['ResourceProperties']['BucketId'], physicalResourceId, event['ResourceProperties']['PlainText'])",
                                "            print 'The secret file created'",
                                "            response = { 'FileId': physicalResourceId }",
                                "            return cfnresponse.send(event, context, cfnresponse.SUCCESS, response, physicalResourceId)",
                                "",
                                "    except Exception as E:",
                                "        print E",
                                "        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                            ]
                        ]
                    }
                },
                "Runtime": "python2.7",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaDeployRole",
                        "Arn"
                    ]
                }
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "192fe816-1984-4ba5-a3f7-29055aad8c80"
                }
            }
        },
		"DeletePasswordLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Description": "Delete file from s3 bucket",
                "Code": {
                    "ZipFile": {
                        "Fn::Join": [
                            "\n",
                            [
                                "import uuid",
								"import boto3",
								"import cfnresponse",
								"",
								"def DeleteFile(bucket, filePath):",
								"    s3Client = boto3.client('s3', config= boto3.session.Config(signature_version='s3v4'))",
								"    response = s3Client.delete_object(Bucket = bucket, Key = filePath)",
								"    print response",
								"",    
								"def lambda_handler(event, context):",
								"",
								"    physicalResourceId = str(uuid.uuid4())",
								"    if 'PhysicalResourceId' in event:",
								"        physicalResourceId = event['PhysicalResourceId']",
								"    ",
								"    try:",
								"        if event['RequestType'] == 'Create':",
								"            DeleteFile(event['ResourceProperties']['bucket'], event['ResourceProperties']['key'])",
								"            print 'File Deleted'",
								"            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
								"        if event['RequestType'] == 'Delete':",
								"            return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)",
								"",
								"    except Exception as E:",
								"        print E",
								"        return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)"
                            ]
                        ]
                    }
                },
                "Runtime": "python2.7",
                "Handler": "index.lambda_handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaDeployRole",
                        "Arn"
                    ]
                }
            },
            "Condition": "EULACondition"
        },
        "StoreAdminPassword": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Version": "1.0",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "StorePasswordLambda",
                        "Arn"
                    ]
                },
                "BucketId": {
                    "Ref": "DeployBucket"
                },
                "PlainText": {
                    "Ref": "VaultAdminPassword"
                }
            },
            "Condition": "EULACondition",
            "DependsOn": [
                "LambdaDeployRole",
                "DeployBucketPolicy",
                "StorePasswordLambda",
                "DeployBucket"
            ],
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "69245eb8-bdbd-4010-8c12-427f13304df6"
                }
            }
        },
		"CleanAdminPassword": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Version": "1.0",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "DeletePasswordLambda",
                        "Arn"
                    ]
                },
                "bucket": {
                    "Ref": "DeployBucket"
                },
                "key": {
                    "Fn::GetAtt": [
						"StoreAdminPassword",
						"FileId"
					]
                },
				
				"dummyDependency": {
					"Fn::If": [
						"CreateCPMCondition", {
							"Fn::GetAtt": ["CPMMachine", "PrivateIp"]
						}, {
							"Fn::If": [
								"CreatePVWACondition", {
									"Fn::GetAtt": ["PVWAMachine", "PrivateIp"]
								}, {
									"Fn::If": [
										"CreatePSMCondition", {
											"Fn::GetAtt": ["PSMMachine", "PrivateIp"]
										}, {
											"Fn::GetAtt": ["PSMPMachine", "PrivateIp"]
										}
									]

								}
							]
						}
					]
				}

            },
            "Condition": "EULACondition",
            "DependsOn": [
                "LambdaDeployRole",
                "DeployBucketPolicy",
                "StorePasswordLambda",
                "DeployBucket"
            ]
        },
        "ComponentInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "ComponentInstanceRole"
                    }
                ]
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0a86e69d-bcb8-4af3-a110-fc22bccb01bc"
                }
            }
        },
        "ComponentInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    {
                                        "Fn::FindInMap": [
                                            "Region2Principal",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "EC2Principal"
                                        ]
                                    }
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
                ],
                "Policies": [
                    {
                        "PolicyName": "LogRolePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents",
                                        "logs:DescribeLogStreams"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::Join": [
                                                "",
                                                [
                                                    {
                                                        "Fn::FindInMap": [
                                                            "Region2ARNPrefix",
                                                            {
                                                                "Ref": "AWS::Region"
                                                            },
                                                            "ARNPrefix"
                                                        ]
                                                    },
                                                    "logs:*:*:*"
                                                ]
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                ]
            },
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e0ba415c-61e6-41bf-b795-a8f45558060a"
                }
            }
        },
        "CPMMachine": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "ComponentInstanceName"
                        }
                    }
                ],
                "SecurityGroupIds": {
                    "Ref": "ComponentInstanceSecurityGroups"
                },
                "SubnetId": {
                    "Ref": "ComponentInstanceSubnetId"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "Components"
                    ]
                },
                "InstanceType": {
                    "Ref": "ComponentInstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r CPMMachine",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "cfn-signal.exe -e %ERRORLEVEL% ",
                                "  --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "  --resource CPMMachine",
                                "  --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "IamInstanceProfile": {
                    "Ref": "ComponentInstanceProfile"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "files": {
                            "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "{",
                                            "  \"IsEnabled\" : true,",
                                            "  \"EngineConfiguration\" : {",
                                            "    \"PollInterval\" : \"00:00:05\",",
                                            "    \"Components\" : [",
                                            "    {",
                                            "      \"Id\" : \"EC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"EC2ConfigLog.txt\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"UTC\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init-cmd.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-wire.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                            "      }",
                                            "    }],",
                                            "    \"Flows\": {",
                                            "      \"Flows\": [",
                                            "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                            "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                            "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                            "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                            "      ]",
                                            "    }",
                                            "  }",
                                            "}"
                                        ]
                                    ]
                                }
                            },
                            "C:\\deploy.py": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "import sys\n",
                                            "import subprocess\n",
                                            "\n",
                                            "callArray = [",
                                            "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                            "'CPM',",
                                            "'/accepteula',",
                                            "'Yes',",
                                            "'/vaultip',",
                                            "'",
                                            {
                                                "Ref": "VaultPrivateIP"
                                            },
											{
												"Fn::If" : [
													"DRValueEmpty",
													{
														"Fn::Join": [
															"",
															[
																"',"
															]
														]
													},
													{
														"Fn::Join": [
															"",
															[
																",",
																{ "Ref" : "DRPrivateIP" },
																"',"
															]
														]
													}
												]
											},
                                            "'/vaultport',",
                                            "'1858',",
                                            "'/vaultuser',",
                                            "'",
                                            {
                                                "Ref": "VaultAdminUser"
                                            },
                                            "',",
                                            "'/bucketname',",
                                            "'",
                                            {
                                                "Ref": "DeployBucket"
                                            },
                                            "',",
                                            "'/objectkey',",
                                            "'",
                                            {
                                                "Fn::GetAtt": [
                                                    "StoreAdminPassword",
                                                    "FileId"
                                                ]
                                            },
                                            "']\n",
                                            "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "0-enableSSM": {
                                "command": "powershell.exe -Command \"Set-Service -Name AmazonSSMAgent -StartupType Automatic\"",
                                "waitAfterCompletion": "0"
                            },
                            "1-restartSSM": {
                                "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                                "waitAfterCompletion": "30"
                            },
                            "2-deploy": {
                                "command": "C:\\Python27\\python.exe C:\\deploy.py",
                                "waitAfterCompletion": "0"
                            },
                            "3-CPMserviceConfig": {
                                "command": "sc config \"CyberArk Password Manager\" start=auto",
                                "waitAfterCompletion": "0"
                            },
                            "4-CPMSserviceConfig": {
                                "command": "sc config \"CyberArk Central Policy Manager Scanner\" start=auto",
                                "waitAfterCompletion": "0"
                            },
                            "5-CPMserviceStart": {
                                "command": "sc start \"CyberArk Password Manager\"",
                                "waitAfterCompletion": "0"
                            },
                            "6-CPMSserviceStart": {
                                "command": "sc start \"CyberArk Central Policy Manager Scanner\"",
                                "waitAfterCompletion": "0"
                            },
                            "7-ChangeHostName": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command Rename-Computer -NewName ",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            " -Force -Restart"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            }
                        }
                    }
                }
            },
            "DependsOn": [
                "StoreAdminPassword"
            ],
            "Condition": "CreateCPMCondition",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M"
                }
            },
            "DeletionPolicy": "Retain"
        },
        "PVWAMachine": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "ComponentInstanceName"
                        }
                    }
                ],
                "SecurityGroupIds": {
                    "Ref": "ComponentInstanceSecurityGroups"
                },
                "SubnetId": {
                    "Ref": "ComponentInstanceSubnetId"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "Components"
                    ]
                },
                "InstanceType": {
                    "Ref": "ComponentInstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r PVWAMachine",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "cfn-signal.exe -e %ERRORLEVEL% ",
                                "  --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "  --resource PVWAMachine",
                                "  --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "IamInstanceProfile": {
                    "Ref": "ComponentInstanceProfile"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "files": {
                            "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "{",
                                            "  \"IsEnabled\" : true,",
                                            "  \"EngineConfiguration\" : {",
                                            "    \"PollInterval\" : \"00:00:05\",",
                                            "    \"Components\" : [",
                                            "    {",
                                            "      \"Id\" : \"EC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"EC2ConfigLog.txt\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"UTC\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init-cmd.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-wire.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                            "      }",
                                            "    }],",
                                            "    \"Flows\": {",
                                            "      \"Flows\": [",
                                            "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                            "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                            "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                            "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                            "      ]",
                                            "    }",
                                            "  }",
                                            "}"
                                        ]
                                    ]
                                }
                            },
                            "C:\\deploy.py": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "import sys\n",
                                            "import subprocess\n",
                                            "\n",
                                            "callArray = [",
                                            "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                            "'PVWA',",
                                            "'/accepteula',",
                                            "'Yes',",
                                            "'/vaultip',",
                                            "'",
                                            {
                                                "Ref": "VaultPrivateIP"
                                            },
											{
												"Fn::If" : [
													"DRValueEmpty",
													{
														"Fn::Join": [
															"",
															[
																"',"
															]
														]
													},
													{
														"Fn::Join": [
															"",
															[
																",",
																{ "Ref" : "DRPrivateIP" },
																"',"
															]
														]
													}
												]
											},
                                            "'/vaultport',",
                                            "'1858',",
                                            "'/vaultuser',",
                                            "'",
                                            {
                                                "Ref": "VaultAdminUser"
                                            },
                                            "',",
                                            "'/bucketname',",
                                            "'",
                                            {
                                                "Ref": "DeployBucket"
                                            },
                                            "',",
                                            "'/objectkey',",
                                            "'",
                                            {
                                                "Fn::GetAtt": [
                                                    "StoreAdminPassword",
                                                    "FileId"
                                                ]
                                            },
                                            "']\n",
                                            "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "0-enableSSM": {
                                "command": "powershell.exe -Command \"Set-Service -Name AmazonSSMAgent -StartupType Automatic\"",
                                "waitAfterCompletion": "0"
                            },
                            "1-restartSSM": {
                                "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                                "waitAfterCompletion": "30"
                            },
                            "2-deploy": {
                                "command": "C:\\Python27\\python.exe C:\\deploy.py",
                                "waitAfterCompletion": "0"
                            },
                            "3-startAppPool": {
                                "command": "powershell -command \"& {&'Import-Module' WebAdministration}\"; \"& {&'Start-WebAppPool' -Name PasswordVaultWebAccessPool}\"; \"& {&'Set-ItemProperty' -Path IIS:\\AppPools\\PasswordVaultWebAccessPool -Name autoStart -Value 'true'}\"",
                                "waitAfterCompletion": "0"
                            },
                            "4-CSTserviceConfig": {
                                "command": "sc config \"CyberArk Scheduled Tasks\" start=auto",
                                "waitAfterCompletion": "0"
                            },
                            "5-CSTserviceStart": {
                                "command": "sc start \"CyberArk Scheduled Tasks\"",
                                "waitAfterCompletion": "0"
                            },
                            "6-ChangeHostName": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command Rename-Computer -NewName ",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            " -Force -Restart"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            }
                        }
                    }
                }
            },
            "DependsOn": [
                "StoreAdminPassword"
            ],
            "Condition": "CreatePVWACondition",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M"
                }
            },
            "DeletionPolicy": "Retain"
        },
        "PSMMachine": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "ComponentInstanceName"
                        }
                    }
                ],
                "SecurityGroupIds": {
                    "Ref": "ComponentInstanceSecurityGroups"
                },
                "SubnetId": {
                    "Ref": "ComponentInstanceSubnetId"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "Components"
                    ]
                },
                "InstanceType": {
                    "Ref": "ComponentInstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<script>\n",
                                "cfn-init.exe -v -s ",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                " -r PSMMachine",
                                " --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "cfn-signal.exe -e %ERRORLEVEL% ",
                                "  --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "  --resource PSMMachine",
                                "  --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "</script>"
                            ]
                        ]
                    }
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "IamInstanceProfile": {
                    "Ref": "ComponentInstanceProfile"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "config": {
                        "files": {
                            "C:\\Program Files\\Amazon\\SSM\\Plugins\\awsCloudWatch\\AWS.EC2.Windows.CloudWatch.json": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "{",
                                            "  \"IsEnabled\" : true,",
                                            "  \"EngineConfiguration\" : {",
                                            "    \"PollInterval\" : \"00:00:05\",",
                                            "    \"Components\" : [",
                                            "    {",
                                            "      \"Id\" : \"EC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\Program Files\\\\Amazon\\\\Ec2ConfigService\\\\Logs\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-ddTHH:mm:ss.fffZ:\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"EC2ConfigLog.txt\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"UTC\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-init-cmd.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"LogDirectoryPath\": \"C:\\\\cfn\\\\log\",",
                                            "        \"TimestampFormat\": \"yyyy-MM-dd HH:mm:ss,fff\",",
                                            "        \"Encoding\": \"ASCII\",",
                                            "        \"Filter\": \"cfn-wire.log\",",
                                            "        \"CultureName\": \"en-US\",",
                                            "        \"TimeZoneKind\": \"Local\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchEC2ConfigLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/EC2ConfigLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnInitCmdLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnInitCmdLog\"",
                                            "      }",
                                            "    },",
                                            "    {",
                                            "      \"Id\": \"CloudWatchCfnWireLog\",",
                                            "      \"FullName\": \"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch\",",
                                            "      \"Parameters\": {",
                                            "        \"AccessKey\": \"\",",
                                            "        \"SecretKey\": \"\",",
                                            {
                                                "Fn::Sub": "        \"Region\": \"${AWS::Region}\","
                                            },
                                            {
                                                "Fn::Sub": "        \"LogGroup\": \"${LogGroup}\","
                                            },
                                            "        \"LogStream\": \"{instance_id}/CfnWireLog\"",
                                            "      }",
                                            "    }],",
                                            "    \"Flows\": {",
                                            "      \"Flows\": [",
                                            "        \"EC2ConfigLog,CloudWatchEC2ConfigLog\",",
                                            "        \"CfnInitLog,CloudWatchCfnInitLog\",",
                                            "        \"CfnInitCmdLog,CloudWatchCfnInitCmdLog\",",
                                            "        \"CfnWireLog,CloudWatchCfnWireLog\"",
                                            "      ]",
                                            "    }",
                                            "  }",
                                            "}"
                                        ]
                                    ]
                                }
                            },
                            "C:\\deploy.py": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "import sys\n",
                                            "import subprocess\n",
                                            "import urllib2\n",
                                            "\n",
                                            "callArray = [",
                                            "'C:\\\\CyberArk\\\\Components Registration\\\\RegisterComponent.exe',",
                                            "'PSM',",
                                            "'/accepteula',",
                                            "'Yes',",
                                            "'/vaultip',",
                                            "'",
                                            {
                                                "Ref": "VaultPrivateIP"
                                            },
											{
												"Fn::If" : [
													"DRValueEmpty",
													{
														"Fn::Join": [
															"",
															[
																"',"
															]
														]
													},
													{
														"Fn::Join": [
															"",
															[
																",",
																{ "Ref" : "DRPrivateIP" },
																"',"
															]
														]
													}
												]
											},
                                            "'/vaultport',",
                                            "'1858',",
                                            "'/vaultuser',",
                                            "'",
                                            {
                                                "Ref": "VaultAdminUser"
                                            },
                                            "',",
                                            "'/bucketname',",
                                            "'",
                                            {
                                                "Ref": "DeployBucket"
                                            },
                                            "',",
                                            "'/objectkey',",
                                            "'",
                                            {
                                                "Fn::GetAtt": [
                                                    "StoreAdminPassword",
                                                    "FileId"
                                                ]
                                            },
                                            "']\n",
                                            "properties = urllib2.urlopen('http://169.254.169.254/latest/meta-data').read()\n",
                                            "if 'public-ipv4' in properties:\n",
                                            "\tipv4 = urllib2.urlopen('http://169.254.169.254/latest/meta-data/public-ipv4').read()\n",
                                            "\tif ipv4 and ipv4 <> 'none':\n",
                                            "\t\tcallArray.append('/psmpublicip')\n",
                                            "\t\tcallArray.append(ipv4)\n",
                                            "sys.exit(subprocess.call(callArray, cwd='C:\\CyberArk\\Components Registration'))\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "0-enableSSM": {
                                "command": "powershell.exe -Command \"Set-Service -Name AmazonSSMAgent -StartupType Automatic\"",
                                "waitAfterCompletion": "0"
                            },
                            "1-restartSSM": {
                                "command": "powershell.exe -Command \"Restart-Service AmazonSSMAgent\"",
                                "waitAfterCompletion": "30"
                            },
                            "2-deploy": {
                                "command": "C:\\Python27\\python.exe C:\\deploy.py",
                                "waitAfterCompletion": "0"
                            },
                            "3-PSMserviceConfig": {
                                "command": "sc config \"Cyber-Ark Privileged Session Manager\" start=auto",
                                "waitAfterCompletion": "0"
                            },
                            "4-ChangeHostName": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "powershell.exe -Command Rename-Computer -NewName ",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            " -Force -Restart"
                                        ]
                                    ]
                                },
                                "waitAfterCompletion": "forever"
                            }
                        }
                    }
                },
                "AWS::CloudFormation::Designer": {
                    "id": "ad4995b9-77b9-4d96-afff-1d18fe66b453"
                }
            },
            "DependsOn": [
                "StoreAdminPassword"
            ],
            "Condition": "CreatePSMCondition",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M"
                }
            },
            "DeletionPolicy": "Retain"
        },
        "PSMPMachine": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "ComponentInstanceName"
                        }
                    }
                ],
                "SecurityGroupIds": {
                    "Ref": "ComponentInstanceSecurityGroups"
                },
                "SubnetId": {
                    "Ref": "ComponentInstanceSubnetId"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "PSMP"
                    ]
                },
                "InstanceType": {
                    "Ref": "ComponentInstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -e\n",
                                "/opt/aws/bin/cfn-init -v ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource PSMPMachine ",
                                "         --configsets install_all ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "/opt/aws/bin/cfn-signal -e $? ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource PSMPMachine ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "IamInstanceProfile": {
                    "Ref": "ComponentInstanceProfile"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "install_all": [
                            "install_cfn",
                            "install_logs",
                            "install_psmp"
                        ]
                    },
                    "install_cfn": {
                        "files": {
                            "/etc/cfn/cfn-hup.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[main]\n",
                                            "stack=",
                                            {
                                                "Ref": "AWS::StackId"
                                            },
                                            "\n",
                                            "region=",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                },
                                "mode": "000400",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[cfn-auto-reloader-hook]\n",
                                            "triggers=post.update\n",
                                            "path=Resources.PSMPMachine.Metadata.AWS::CloudFormation::Init\n",
                                            "action=/opt/aws/bin/cfn-init -v ",
                                            "         --stack ",
                                            {
                                                "Ref": "AWS::StackName"
                                            },
                                            "         --resource PSMPMachine ",
                                            "         --configsets install_all ",
                                            "         --region ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n",
                                            "runas=root\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "services": {
                            "sysvinit": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/cfn/cfn-hup.conf",
                                        "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "install_logs": {
                        "files": {
                            "/etc/awslogs/awslogs.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[general]\n",
                                            "state_file= /var/awslogs/state/agent-state\n",
                                            "[/var/log/cloud-init.log]\n",
                                            "file = /var/log/cloud-init.log\n",
                                            "log_group_name = ",
                                            {
                                                "Ref": "LogGroup"
                                            },
                                            "\n",
                                            "log_stream_name = {instance_id}/cloud-init.log\n",
                                            "datetime_format = \n",
                                            "[/var/log/cloud-init-output.log]\n",
                                            "file = /var/log/cloud-init-output.log\n",
                                            "log_group_name = ",
                                            {
                                                "Ref": "LogGroup"
                                            },
                                            "\n",
                                            "log_stream_name = {instance_id}/cloud-init-output.log\n",
                                            "datetime_format = \n",
                                            "[/var/log/cfn-init.log]\n",
                                            "file = /var/log/cfn-init.log\n",
                                            "log_group_name = ",
                                            {
                                                "Ref": "LogGroup"
                                            },
                                            "\n",
                                            "log_stream_name = {instance_id}/cfn-init.log\n",
                                            "datetime_format = \n",
                                            "[/var/log/cfn-hup.log]\n",
                                            "file = /var/log/cfn-hup.log\n",
                                            "log_group_name = ",
                                            {
                                                "Ref": "LogGroup"
                                            },
                                            "\n",
                                            "log_stream_name = {instance_id}/cfn-hup.log\n",
                                            "datetime_format = \n",
                                            "[/var/log/cfn-wire.log]\n",
                                            "file = /var/log/cfn-wire.log\n",
                                            "log_group_name = ",
                                            {
                                                "Ref": "LogGroup"
                                            },
                                            "\n",
                                            "log_stream_name = {instance_id}/cfn-wire.log\n",
                                            "datetime_format = \n"
                                        ]
                                    ]
                                },
                                "mode": "000444",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/awslogs/awscli.conf": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "[plugins]\n",
                                            "cwlogs = cwlogs\n",
                                            "[default]\n",
                                            "region = ",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            "\n"
                                        ]
                                    ]
                                },
                                "mode": "000444",
                                "owner": "root",
                                "group": "root"
                            }
                        },
                        "commands": {
                            "01_create_state_directory": {
                                "command": "mkdir -p /var/awslogs/state"
                            }
                        },
                        "services": {
                            "sysvinit": {
                                "awslogs": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/awslogs/awslogs.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "install_psmp": {
                        "files": {
                            "/root/CD-Image/activatePSMP": {
                                "content": {
                                    "Fn::Join": [
                                        "",
                                        [
											"#!/bin/bash -e\n",
											"chmod 700 /root/CD-Image/register_and_activation.sh\n",
											"aws configure set default.s3.signature_version s3v4\n",
											"aws s3api get-object --bucket ",
												{
													"Ref": "DeployBucket"
												},
												" --key ", 
												{
													"Fn::GetAtt": [
														"StoreAdminPassword",
														"FileId"
													]
												},
												" /root/CD-Image/temppassword\n",
											"echo Object successfully retrieved from S3 bucket.\n",
											
											"/opt/CARKpsmp/bin/createcredfile /root/CD-Image/user.cred Password -Username ",
											{
                                                "Ref": "VaultAdminUser"
                                            }, 
											" -Password $(cat /root/CD-Image/temppassword) -Hostname\n",
											"echo Credentials file successfully created.\n",
											
											"shred -u /root/CD-Image/temppassword\n",
											"aws s3api delete-object --bucket ",
												{
													"Ref": "DeployBucket"
												},
												" --key ",
												{
													"Fn::GetAtt": [
														"StoreAdminPassword",
														"FileId"
													]
												},
												"\n",
											"echo Object successfully deleted from S3 bucket.\n",
											
											"/root/CD-Image/register_and_activation.sh /root/CD-Image/user.cred ",
												{
													"Fn::If" : [
														"DRValueEmpty",
														{
															"Fn::Join": [
																"",
																[
																	{"Ref": "VaultPrivateIP"}
																]
															]
														},
														{
															"Fn::Join": [
																"",
																[
																	{"Ref": "VaultPrivateIP"},
																	",",
																	{ "Ref" : "DRPrivateIP" }
																]
															]
														}
													]
												},
												" $(curl http://169.254.169.254/latest/meta-data/instance-id) y\n"
                                        ]
                                    ]
                                }
                            }
                        },
                        "commands": {
                            "00-ChangeHostName": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sudo hostname ",
                                            {
                                                "Ref": "ComponentHostName"
                                            }
                                        ]
                                    ]
                                }
                            },
                            "01-ChangeHostName-chmod-hosts": {
                                "command": "sudo chmod 646 /etc/hosts"
                            },
                            "02-ChangeHostName-sed-hosts1": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sudo sed -i 's/localhost\\./",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            "./g' /etc/hosts"
                                        ]
                                    ]
                                }
                            },
                            "03-ChangeHostName-sed-hosts2": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sudo sed -i 's/localhost /",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            " /g' /etc/hosts"
                                        ]
                                    ]
                                }
                            },
                            "04-ChangeHostName-chmod-network": {
                                "command": "sudo chmod 646 /etc/sysconfig/network"
                            },
                            "05-ChangeHostName-sed-network": {
                                "command": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "sudo sed -i 's/HOSTNAME=localhost.localdomain/HOSTNAME=",
                                            {
                                                "Ref": "ComponentHostName"
                                            },
                                            "/g' /etc/sysconfig/network"
                                        ]
                                    ]
                                }
                            },
                            "06-ChangeHostName-chmod-hosts-revert": {
                                "command": "sudo chmod 644 /etc/hosts"
                            },
                            "07-ChangeHostName-chmod-network-revert": {
                                "command": "sudo chmod 644 /etc/sysconfig/network"
                            },
                            "08-Chmod": {
                                "command": "sudo chmod 700 /root/CD-Image/activatePSMP"
                            },
                            "09-PSMPdeploy": {
                                "command": "sudo /root/CD-Image/activatePSMP"
                            },
                            "10-ClearData": {
                                "command": "sudo shred -u /root/CD-Image/activatePSMP"
                            },
                            "11-RemoveInstallationFolder": {
                                "command": "sudo rm -rf /root/CD-Image/"
                            }
                        }
                    }
                }
            },
            "DependsOn": [
                "StoreAdminPassword"
            ],
            "Condition": "CreatePSMPCondition",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT10M"
                }
            },
			"DeletionPolicy": "Retain"
        },
        "ComponentS3DeployBucketPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "ComponentInstancesDeployBucketAccess",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:GetObjectVersion",
                                "s3:DeleteObject",
                                "s3:DeleteObjectVersion"
                            ],
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "DeployBucket"
                                        },
                                        "/",
                                        {
                                            "Fn::GetAtt": [
                                                "StoreAdminPassword",
                                                "FileId"
                                            ]
                                        }
                                    ]
                                ]
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "ComponentInstanceRole"
                    }
                ]
            },
            "DependsOn": [
                "StoreAdminPassword",
                "DeployBucket"
            ],
            "Condition": "EULACondition",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4e192270-c648-4ac1-b63d-bf91d1647242"
                }
            }
        }
    },
    "Parameters": {
        "EULA": {
            "Type": "String",
            "Description": "I have read and agree to the Terms and Conditions.",
            "AllowedValues": [
                "Accept",
                "Decline"
            ],
            "Default": "Decline"
        },
        "KeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Select an existing Key Pair from your AWS account.",
            "ConstraintDescription": "Can contain only ASCII characters."
        },
        "VaultPrivateIP": {
            "Type": "String",
            "Description": "Enter the IP of the Vault instance."
        },
        "DRPrivateIP": {
            "Type": "String",
            "Description": "Enter the IP of the Vault DR instance. (Optional)"
        },
		"VaultAdminUser": {
            "Type": "String",
            "Description": "Enter the Administrator Vault user.",
            "Default": "Administrator",
            "MinLength": 8
        },
        "VaultAdminPassword": {
            "Type": "String",
            "Description": "Enter a password for the Vault Administrator user.",
            "NoEcho": true,
            "MinLength": 8
        },
        "ComponentToInstall": {
            "Type": "String",
            "Description": "Choose the Component to install.",
            "AllowedValues": ["CPM", "PVWA", "PSM","PSMP"],
            "Default": "CPM"
        },
        "ComponentInstanceName": {
            "Type": "String",
            "Description": "Enter a name for the PAS Component instance.",
            "Default": "Components"
        },
		"ComponentHostName": {
            "Type": "String",
            "Description": "Enter the host name for the PAS Component instance."
        },
        "ComponentInstanceType": {
            "Type": "String",
            "Description": "Select the instance type of the Component instance.",
            "AllowedValues": [
                "m4.large",
                "m4.xlarge",
                "m4.2xlarge",
                "m4.4xlarge"
            ],
            "Default": "m4.large"
        },
        "ComponentInstanceSecurityGroups": {
            "Type": "List<AWS::EC2::SecurityGroup::Id>",
            "Description": "Assign Security Groups to the Component instance."
        },
        "ComponentInstanceSubnetId": {
            "Type": "AWS::EC2::Subnet::Id",
            "Description": "Select the Subnet Id where the Component instance will reside."
        }
    },
    "Conditions": {
        "EULACondition": {
            "Fn::Equals": [
                "Accept",
                {
                    "Ref": "EULA"
                }
            ]
        },
        "CreateCPMCondition" : {
            "Fn::Equals": [
                "CPM",
                {
                    "Ref" : "ComponentToInstall"
                }
           ]
        },
        "CreatePVWACondition" : {
            "Fn::Equals": [
                "PVWA",
                {
                    "Ref" : "ComponentToInstall"
                }
           ]
        },
        "CreatePSMCondition" : {
            "Fn::Equals": [
                "PSM",
                {
                    "Ref" : "ComponentToInstall"
                }
           ]
        },
        "CreatePSMPCondition" : {
            "Fn::Equals": [
                "PSMP",
                {
                    "Ref" : "ComponentToInstall"
                }
           ]
        },
		"DRValueEmpty" : {
			"Fn::Equals": [
				"",
				{
					"Ref" : "DRPrivateIP"
				}
			]
		}
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "General parameters"
                    },
                    "Parameters": [
                        "EULA",
                        "KeyName"
                    ]
                },
                {
                    "Label": {
                        "default": "Vault and DR information"
                    },
                    "Parameters": [
                        "VaultPrivateIP",
                        "DRPrivateIP",
						"VaultAdminUser",
                        "VaultAdminPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "Component configuration"
                    },
                    "Parameters": [
                        "ComponentToInstall",
                        "ComponentInstanceName",
						"ComponentHostName",
                        "ComponentInstanceType",
                        "ComponentInstanceSecurityGroups",
                        "ComponentInstanceSubnetId"
                    ]
                }
            ],
            "ParameterLabels": {
                "EULA": {
                    "default": "License Agreement"
                },
                "KeyName": {
                    "default": "Key Pair"
                },
                "VaultPrivateIP": {
                    "default": "Vault Private IP"
                },
                "DRPrivateIP": {
                    "default": "Vault DR Private IP"
                },
				"VaultAdminUser": {
                    "default": "Vault Admin User"
                },
                "VaultAdminPassword": {
                    "default": "Vault Admin Password"
                },
                "ComponentToInstall": {
                    "default": "Component To Install"
                },
                "ComponentInstanceName": {
                    "default": "Component Instance Name"
                },
				"ComponentHostName": {
                    "default": "Component Host Name"
                },
                "ComponentInstanceType": {
                    "default": "Component Instance Type"
                },
                "ComponentInstanceSecurityGroups": {
                    "default": "Component Instance Security Groups"
                },
                "ComponentInstanceSubnetId": {
                    "default": "Component Instance Subnet Id"
                }
            }
        },
        "AWS::CloudFormation::Designer": {
            "e0ba415c-61e6-41bf-b795-a8f45558060a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 80,
                    "y": 80
                },
                "z": 1,
                "embeds": []
            },
            "0a86e69d-bcb8-4af3-a110-fc22bccb01bc": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -30,
                    "y": 130
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "e0ba415c-61e6-41bf-b795-a8f45558060a"
                ]
            },
            "23d3a636-2b70-4f0c-8849-9e7861edb7b6": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 490,
                    "y": 370
                },
                "z": 1,
                "embeds": []
            },
            "192fe816-1984-4ba5-a3f7-29055aad8c80": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 500,
                    "y": 240
                },
                "z": 1,
                "embeds": []
            },
            "fc7df917-b0b9-4452-9aaf-e71861744c7d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 500,
                    "y": 80
                },
                "z": 1,
                "embeds": []
            },
            "e0f67985-8361-4891-b23a-860e90e37412": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 500,
                    "y": 160
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "fc7df917-b0b9-4452-9aaf-e71861744c7d"
                ]
            },
            "69245eb8-bdbd-4010-8c12-427f13304df6": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 340
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "23d3a636-2b70-4f0c-8849-9e7861edb7b6",
                    "e0f67985-8361-4891-b23a-860e90e37412"
                ]
            },
            "4e192270-c648-4ac1-b63d-bf91d1647242": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 150,
                    "y": 220
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "e0ba415c-61e6-41bf-b795-a8f45558060a"
                ]
            },
            "ad4995b9-77b9-4d96-afff-1d18fe66b453": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -20,
                    "y": 350
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "69245eb8-bdbd-4010-8c12-427f13304df6",
                    "fc7df917-b0b9-4452-9aaf-e71861744c7d"
                ]
            }
        }
    },
    "Mappings": {
        "RegionMap": {
            "us-east-1": {
                "Vault": "ami-45f2643a",
                "Components": "ami-0c0e9973",
                "PSMP": "ami-a6f167d9"
            },
            "us-east-2": {
                "Vault": "ami-239fa246",
                "Components": "ami-57a29f32",
                "PSMP": "ami-6e9ea30b"
            },
            "us-west-1": {
                "Vault": "ami-60213800",
                "Components": "ami-4a342d2a",
                "PSMP": "ami-c22f36a2"
            },
            "us-west-2": {
                "Vault": "ami-a291e3da",
                "Components": "ami-46b9cb3e",
                "PSMP": "ami-e796e49f"
            },
            "ca-central-1": {
                "Vault": "ami-9550d0f1",
                "Components": "ami-6f4bcb0b",
                "PSMP": "ami-9250d0f6"
            },
            "eu-west-1": {
                "Vault": "ami-e0af9f99",
                "Components": "ami-95b383ec",
                "PSMP": "ami-3faf9f46"
            },
            "eu-central-1": {
                "Vault": "ami-f9cae512",
                "Components": "ami-7cf8d797",
                "PSMP": "ami-acc8e747"
            },
            "eu-west-2": {
                "Vault": "ami-f66a8891",
                "Components": "ami-0ce70a6b",
                "PSMP": "ami-a99674ce"
            },
            "ap-southeast-1": {
                "Vault": "ami-556d5c29",
                "Components": "ami-de7849a2",
                "PSMP": "ami-506d5c2c"
            },
            "ap-southeast-2": {
                "Vault": "ami-d18253b3",
                "Components": "ami-f896479a",
                "PSMP": "ami-b18150d3"
            },
            "ap-northeast-2": {
                "Vault": "ami-23b51d4d",
                "Components": "ami-91bf17ff",
                "PSMP": "ami-d9b119b7"
            },
            "ap-northeast-1": {
                "Vault": "ami-ac17e0d3",
                "Components": "ami-a327d0dc",
                "PSMP": "ami-982adde7"
            },
            "ap-south-1": {
                "Vault": "ami-676d4008",
                "Components": "ami-7795b718",
                "PSMP": "ami-776c4118"
            },
            "sa-east-1": {
                "Vault": "ami-96b7ebfa",
                "Components": "ami-0e87db62",
                "PSMP": "ami-fdb4e891"
            }
        },
        "Region2ARNPrefix": {
            "us-east-1": {
                "ARNPrefix": "arn:aws:"
            },
            "us-west-1": {
                "ARNPrefix": "arn:aws:"
            },
            "us-west-2": {
                "ARNPrefix": "arn:aws:"
            },
            "eu-west-1": {
                "ARNPrefix": "arn:aws:"
            },
            "ap-northeast-1": {
                "ARNPrefix": "arn:aws:"
            },
            "ap-southeast-1": {
                "ARNPrefix": "arn:aws:"
            },
            "ap-southeast-2": {
                "ARNPrefix": "arn:aws:"
            },
            "sa-east-1": {
                "ARNPrefix": "arn:aws:"
            },
            "cn-north-1": {
                "ARNPrefix": "arn:aws-cn:"
            },
            "eu-central-1": {
                "ARNPrefix": "arn:aws:"
            }
        },
        "Region2Principal": {
            "us-east-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "us-west-2": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "us-west-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "eu-west-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "ap-southeast-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "ap-northeast-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "ap-southeast-2": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "sa-east-1": {
                "EC2Principal": "ec2.amazonaws.com"
            },
            "cn-north-1": {
                "EC2Principal": "ec2.amazonaws.com.cn"
            },
            "eu-central-1": {
                "EC2Principal": "ec2.amazonaws.com"
            }
        }
    },
    "Outputs": {
        "CloudWatchLogGroupName": {
            "Description": "The name of the CloudWatch log group",
            "Value": {
                "Ref": "LogGroup"
            }
        }
    }
}

