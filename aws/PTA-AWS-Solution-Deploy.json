{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "EULA": {
            "Type": "String",
            "Description": "I have read and agree to the Terms and Conditions.",
            "AllowedValues": [
                "Accept",
                "Decline"
            ],
            "Default": "Decline"
        }
    },
    "Conditions": {
        "EULACondition": {
            "Fn::Equals": [
                "Accept",
                {
                    "Ref": "EULA"
                }
            ]
        }
    },
    "Resources": {
        "Topic": {
            "Type": "AWS::SNS::Topic"
        },
        "TopicPolicy": {
            "Type": "AWS::SNS::TopicPolicy",
            "Properties": {
                "Topics": [
                    {
                        "Ref": "Topic"
                    }
                ],
                "PolicyDocument": {
                    "Version": "2008-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailSNSPolicy",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Resource": "*",
                            "Action": "SNS:Publish"
                        }
                    ]
                }
            }
        },
        "myTrail": {
            "DependsOn": [
                "BucketPolicy",
                "TopicPolicy"
            ],
            "Type": "AWS::CloudTrail::Trail",
            "Properties": {
                "S3BucketName": {
                   "Ref": "S3Bucket"
                },
                "SnsTopicName": {
                    "Fn::GetAtt": [
                        "Topic",
                        "TopicName"
                    ]
                },
                "IsLogging": true,
                "IsMultiRegionTrail": true,
				"IncludeGlobalServiceEvents": true
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket"
        },
        "BucketPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "PolicyDocument": {
                    "Id": "MyPolicy",
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Sid": "AWSCloudTrailAclCheck20150319",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:GetBucketAcl",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "S3Bucket"
                                        }
                                    ]
                                ]
                            }
                        },
                        {
                            "Sid": "AWSCloudTrailWrite20150319",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "cloudtrail.amazonaws.com"
                            },
                            "Action": "s3:PutObject",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "S3Bucket"
                                        },
                                        "/*"
                                    ]
                                ]
                            },
                            "Condition": {
                                "StringEquals": {
                                    "s3:x-amz-acl": "bucket-owner-full-control"
                                }
                            }
                        }
                    ]
                },
                "Bucket": "S3Bucket"
            }
        },
        "LambdaDeployRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CloudWatch",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:*"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:GetObject",
                                        "s3:PutObject"
                                    ],
                                    "Resource": "arn:aws:s3:::*"
                                }
                            ]
                        }
                    }
                ]
            },
            "Condition": "EULACondition"
        },
        "CloudTrailToSNSFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "index.handler",
                "Runtime": "nodejs8.10",
                "Code": {
                    "S3Bucket": "packages-for-lambda",
                    "S3Key": "PtaCloudTrailToSns.zip"
                },
                "Description": "",
                "MemorySize": 128,
                "Timeout": 20,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaDeployRole",
                        "Arn"
                    ]
                }
            }
        },
        "EventsRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Description": "S3.PutObject for CodePipeline source file",
                "State": "ENABLED",
                "EventPattern": {
                    "source": [
                        "aws.s3"
                    ],
                    "detail": {
                        "eventSource": [
                            "s3.amazonaws.com"
                        ],
                        "eventName": [
                            "PutObject"
                        ],
                        "requestParameters": {
                            "bucketName": {
                                   "Ref": "S3Bucket"
                                }
                        }
                    }
                },
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CloudTrailToSNSFunction",
                                "Arn"
                            ]
                        },
                        "Id": "CloudTrailToSNSFunctionX"
                    }
                ]
            }
        },
        "PermissionForEventsToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "CloudTrailToSNSFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "EventsRule",
                        "Arn"
                    ]
                }
            }
        }
    }
}
