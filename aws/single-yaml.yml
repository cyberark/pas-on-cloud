Resources:
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30
    DeletionPolicy: Retain
  LambdaDeployRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: CloudWatch
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Resource:
                  - '*'
  LambdaLogDenyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: denyLambdaLogging
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Deny
                Action:
                  - logs:*
                Resource: '*'
  RandomStringLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          const response = require("cfn-response");
          const randomString = (length, chars) => {
              var result = '';
              for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
              return result;
          }
          exports.handler = (event, context) =>{
            const str = randomString(1, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') + randomString(1, 'abcdefghijklmnopqrstuvwxyz') + randomString(3, '0123456789') + randomString(11, 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');
            const responseData = {RandomString: str};
            response.send(event, context, response.SUCCESS, responseData);
          };
      Handler: index.handler
      Runtime: nodejs10.x
      Role: !GetAtt 'LambdaLogDenyRole.Arn'
      MemorySize: 128
      Timeout: 20
  ComponentSecretString:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt 'RandomStringLambdaFunction.Arn'
  ComponentInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref 'ComponentInstanceRole'
    Condition: EULACondition
  ComponentInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
      Policies:
        - PolicyName: LogRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource:
                  - !Sub 'arn:${AWS::Partition}:logs:*:*:*'
    Condition: EULACondition
  CPMMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'ComponentInstanceName'
      SecurityGroupIds: !Ref 'ComponentInstanceSecurityGroups'
      SubnetId: !Ref 'ComponentInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - CPM
      InstanceType: !Ref 'ComponentInstanceType'
      UserData: !Base64
        Fn::Sub: |-
          <script>
          cfn-init.exe -v -s ${AWS::StackId} -r CPMMachine --region ${AWS::Region}
          cfn-signal.exe -e %ERRORLEVEL%   --stack ${AWS::StackId}  --resource CPMMachine  --region ${AWS::Region}
          </script>
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'ComponentInstanceProfile'
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json:
              content:
                Fn::Sub: |-
                  {
                    "IsEnabled":true,
                    "EngineConfiguration":{
                      "PollInterval":"00:00:05",
                      "Components":[
                          {
                            "Id":"EC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs",
                                "TimestampFormat":"yyyy-MM-ddTHH:mm:ss.fffZ:",
                                "Encoding":"ASCII",
                                "Filter":"EC2ConfigLog.txt",
                                "CultureName":"en-US",
                                "TimeZoneKind":"UTC"
                            }
                          },
                          {
                            "Id":"CfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init-cmd.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-wire.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CloudWatchEC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/EC2ConfigLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitCmdLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnWireLog"
                            }
                          }
                      ],
                      "Flows":{
                          "Flows":[
                            "EC2ConfigLog,CloudWatchEC2ConfigLog",
                            "CfnInitLog,CloudWatchCfnInitLog",
                            "CfnInitCmdLog,CloudWatchCfnInitCmdLog",
                            "CfnWireLog,CloudWatchCfnWireLog"
                          ]
                      }
                    }
                  }
            C:\Set-LocalAccountPassword.ps1:
              content: |
                [CmdletBinding()]
                Param(
                  [Parameter(Mandatory=$true)][string]$Username,
                  [Parameter(Mandatory=$true)][string]$Password
                )
                $adsi = [ADSI]"WinNT://$env:COMPUTERNAME"
                $existing = $adsi.Children | where {$_.SchemaClassName -eq 'user' -and $_.Name -eq $Username }
                if ($existing -eq $null) {
                    Write-Error "User $Username does not exist"
                    return
                }
                $existing.SetPassword($Password)
            C:\Set-ServiceLogon.ps1:
              content: |
                [CmdletBinding()]
                Param(
                  [Parameter(Mandatory=$true)][string]$Service,
                  [Parameter(Mandatory=$true)][string]$Password
                )
                $filter = 'Name=' + "'" + $Service + "'" + ''
                $s = Get-WMIObject -class Win32_Service -Filter $filter
                $s.Change($Null,$Null,$Null,$Null,$Null,$Null,$Null,$Password,$Null,$Null,$Null)
            C:\deploy.py:
              content: |
                import sys
                import subprocess
                import argparse
                
                parser = argparse.ArgumentParser()
                parser.add_argument("vaultip", type=str, help="vault ip address")
                parser.add_argument("vaultuser", type=str, help="vault administrator user")
                parser.add_argument("vaultpass", type=str, help="vault administrator password")
                args = parser.parse_args()
                
                sys.exit(subprocess.call('powershell.exe C:\\CyberArk\\CloudRegisterToVault.ps1 -CPM -CPMVaultIP \'{}\' -CPMVaultPort 1858 -CPMVaultUser {} -CPMVaultPassword {}'.format(args.vaultip, args.vaultuser, args.vaultpass)))
          services:
            windows:
              AmazonSSMAgent:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json
          commands:
            01-restartSSM:
              command: powershell.exe -Command "Restart-Service AmazonSSMAgent"
              waitAfterCompletion: '30'
              ignoreErrors: 'true'
            02-deploy:
              command:
                Fn::Sub:
                  - 'C:\Python27\python.exe C:\deploy.py ${VaultIpAddress} ${VaultAdminUser} ${VaultAdminPassword}'
                  - VaultIpAddress:
                      !If
                        - DRValueEmpty
                        - !Sub '${VaultPrivateIP}'
                        - !Sub '${VaultPrivateIP},${DRPrivateIP}'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            03-configureCPMUser:
              command: !Sub 'powershell.exe -File C:\Set-LocalAccountPassword.ps1
                -Username "PasswordManagerUser" -Password "${ComponentSecretString.RandomString}"'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            04-configureCPMService:
              command: !Sub 'powershell.exe -File C:\Set-ServiceLogon.ps1 -Service
                "CyberArk Password Manager" -Password "${ComponentSecretString.RandomString}"'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            05-configureCPMScannerService:
              command: !Sub 'powershell.exe -File C:\Set-ServiceLogon.ps1 -Service
                "CyberArk Central Policy Manager Scanner" -Password "${ComponentSecretString.RandomString}"'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            06-CPMserviceConfig:
              command: sc config "CyberArk Password Manager" start=auto
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            07-CPMSserviceConfig:
              command: sc config "CyberArk Central Policy Manager Scanner" start=auto
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            08-ChangeHostName:
              command: !Sub 'powershell.exe -Command Rename-Computer -NewName ${ComponentHostName}
                -Force -Restart'
              waitAfterCompletion: forever
              ignoreErrors: 'false'
            99-SignalCompletion:
              command: !Sub 'cfn-signal.exe -e %ERRORLEVEL%          --stack ${AWS::StackId}         --resource
                CPMMachine          --region ${AWS::Region}'
    Condition: CreateCPMCondition
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    DeletionPolicy: Retain
  PVWAMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'ComponentInstanceName'
      SecurityGroupIds: !Ref 'ComponentInstanceSecurityGroups'
      SubnetId: !Ref 'ComponentInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - PVWA
      InstanceType: !Ref 'ComponentInstanceType'
      UserData: !Base64
        Fn::Sub: |-
          <script>
          cfn-init.exe -v -s ${AWS::StackId} -r PVWAMachine --region ${AWS::Region}
          cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource PVWAMachine --region ${AWS::Region}
          </script>
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'ComponentInstanceProfile'
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json:
              content:
                Fn::Sub: |-
                  {
                    "IsEnabled":true,
                    "EngineConfiguration":{
                      "PollInterval":"00:00:05",
                      "Components":[
                          {
                            "Id":"EC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs",
                                "TimestampFormat":"yyyy-MM-ddTHH:mm:ss.fffZ:",
                                "Encoding":"ASCII",
                                "Filter":"EC2ConfigLog.txt",
                                "CultureName":"en-US",
                                "TimeZoneKind":"UTC"
                            }
                          },
                          {
                            "Id":"CfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init-cmd.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-wire.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CloudWatchEC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/EC2ConfigLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitCmdLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnWireLog"
                            }
                          }
                      ],
                      "Flows":{
                          "Flows":[
                            "EC2ConfigLog,CloudWatchEC2ConfigLog",
                            "CfnInitLog,CloudWatchCfnInitLog",
                            "CfnInitCmdLog,CloudWatchCfnInitCmdLog",
                            "CfnWireLog,CloudWatchCfnWireLog"
                          ]
                      }
                    }
                  }
            C:\Set-LocalAccountPassword.ps1:
              content: |
                [CmdletBinding()]
                Param(
                  [Parameter(Mandatory=$true)][string]$Username,
                  [Parameter(Mandatory=$true)][string]$Password
                )
                $adsi = [ADSI]"WinNT://$env:COMPUTERNAME"
                $existing = $adsi.Children | where {$_.SchemaClassName -eq 'user' -and $_.Name -eq $Username }
                if ($existing -eq $null) {
                    Write-Error "User $Username does not exist"
                    return
                }
                $existing.SetPassword($Password)
            C:\Set-ServiceLogon.ps1:
              content: |
                [CmdletBinding()]
                Param(
                  [Parameter(Mandatory=$true)][string]$Service,
                  [Parameter(Mandatory=$true)][string]$Password
                )
                $filter = 'Name=' + "'" + $Service + "'" + ''
                $s = Get-WMIObject -class Win32_Service -Filter $filter
                $s.Change($Null,$Null,$Null,$Null,$Null,$Null,$Null,$Password,$Null,$Null,$Null)
            C:\deploy.py:
              content:
                !Sub
                  - |
                    import sys
                    import subprocess
                    import argparse
                    import urllib2

                    parser = argparse.ArgumentParser()
                    parser.add_argument("vaultip", type=str, help="vault ip address")
                    parser.add_argument("vaultuser", type=str, help="vault administrator user")
                    parser.add_argument("vaultpass", type=str, help="vault administrator password")
                    args = parser.parse_args()

                    inputHostname = "${InputHostname}"
                    if not inputHostname:
                      hostname = urllib2.urlopen('http://169.254.169.254/latest/meta-data/hostname').read()
                      pvwaurl = 'https://{0}/PasswordVault'.format(hostname)
                    else:
                      pvwaurl = 'https://{0}/PasswordVault'.format(inputHostname)
                    
                    sys.exit(subprocess.call('powershell.exe C:\\CyberArk\\CloudRegisterToVault.ps1 -PVWA -PVWAVaultIP \'{}\' -PVWAVaultPort 1858 -PVWAVaultUser {} -PVWAVaultPassword {} -PVWAURL {}'.format(args.vaultip, args.vaultuser, args.vaultpass, pvwaurl)))

                  - InputHostname:
                      !If
                        - PVWAHostNameEmpty
                        - ''
                        - !Sub '${PVWAHostName}'
          services:
            windows:
              AmazonSSMAgent:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json
          commands:
            01-restartSSM:
              command: powershell.exe -Command "Restart-Service AmazonSSMAgent"
              waitAfterCompletion: '30'
              ignoreErrors: 'true'
            02-deploy:
              command:
                Fn::Sub:
                  - 'C:\Python27\python.exe C:\deploy.py ${VaultIpAddress} ${VaultAdminUser} ${VaultAdminPassword}'
                  - VaultIpAddress:
                      !If
                        - DRValueEmpty
                        - !Sub '${VaultPrivateIP}'
                        - !Sub '${VaultPrivateIP},${DRPrivateIP}'
              ignoreErrors: 'false'
            03-startAppPool:
              command: powershell -command "& {&'Import-Module' WebAdministration}"; "& {&'Start-WebAppPool' -Name PasswordVaultWebAccessPool}"; "& {&'Set-ItemProperty' -Path IIS:\AppPools\PasswordVaultWebAccessPool -Name autoStart -Value 'true'}"
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            04-configurePVWAUser:
              command: !Sub 'powershell.exe -File C:\Set-LocalAccountPassword.ps1 -Username "PVWAReportsUser" -Password "${ComponentSecretString.RandomString}"'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            05-configurePVWAService:
              command: !Sub 'powershell.exe -File C:\Set-ServiceLogon.ps1 -Service "CyberArk Scheduled Tasks" -Password "${ComponentSecretString.RandomString}"'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            06-CSTserviceConfig:
              command: sc config "CyberArk Scheduled Tasks" start=auto
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            08-ChangeHostName:
              command: !Sub 'powershell.exe -Command Rename-Computer -NewName ${ComponentHostName} -Force -Restart'
              waitAfterCompletion: forever
              ignoreErrors: 'false'
            99-SignalCompletion:
              command: !Sub 'cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource PVWAMachine --region ${AWS::Region}'
    Condition: CreatePVWACondition
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    DeletionPolicy: Retain
  PSMMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'ComponentInstanceName'
      SecurityGroupIds: !Ref 'ComponentInstanceSecurityGroups'
      SubnetId: !Ref 'ComponentInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - PSM
      InstanceType: !Ref 'ComponentInstanceType'
      UserData: !Base64
        Fn::Sub: |-
          <script>
          cfn-init.exe -v -s ${AWS::StackId} -r PSMMachine --region ${AWS::Region}
          cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource PSMMachine --region ${AWS::Region}
          </script>
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'ComponentInstanceProfile'
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json:
              content:
                Fn::Sub: |-
                  {
                    "IsEnabled":true,
                    "EngineConfiguration":{
                      "PollInterval":"00:00:05",
                      "Components":[
                          {
                            "Id":"EC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs",
                                "TimestampFormat":"yyyy-MM-ddTHH:mm:ss.fffZ:",
                                "Encoding":"ASCII",
                                "Filter":"EC2ConfigLog.txt",
                                "CultureName":"en-US",
                                "TimeZoneKind":"UTC"
                            }
                          },
                          {
                            "Id":"CfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-init-cmd.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CustomLog.CustomLogInputComponent,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "LogDirectoryPath":"C:\\cfn\\log",
                                "TimestampFormat":"yyyy-MM-dd HH:mm:ss,fff",
                                "Encoding":"ASCII",
                                "Filter":"cfn-wire.log",
                                "CultureName":"en-US",
                                "TimeZoneKind":"Local"
                            }
                          },
                          {
                            "Id":"CloudWatchEC2ConfigLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/EC2ConfigLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnInitCmdLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnInitCmdLog"
                            }
                          },
                          {
                            "Id":"CloudWatchCfnWireLog",
                            "FullName":"AWS.EC2.Windows.CloudWatch.CloudWatchLogsOutput,AWS.EC2.Windows.CloudWatch",
                            "Parameters":{
                                "AccessKey":"",
                                "SecretKey":"",
                                "Region": "${AWS::Region}",
                                "LogGroup": "${LogGroup}",
                                "LogStream":"{instance_id}/CfnWireLog"
                            }
                          }
                      ],
                      "Flows":{
                          "Flows":[
                            "EC2ConfigLog,CloudWatchEC2ConfigLog",
                            "CfnInitLog,CloudWatchCfnInitLog",
                            "CfnInitCmdLog,CloudWatchCfnInitCmdLog",
                            "CfnWireLog,CloudWatchCfnWireLog"
                          ]
                      }
                    }
                  }
            C:\deploy.py:
              content: |
                import sys
                import subprocess
                import argparse
                
                parser = argparse.ArgumentParser()
                parser.add_argument("vaultip", type=str, help="vault ip address")
                parser.add_argument("vaultuser", type=str, help="vault administrator user")
                parser.add_argument("vaultpass", type=str, help="vault administrator password")
                args = parser.parse_args()
                
                sys.exit(subprocess.call('powershell.exe C:\\CyberArk\\CloudRegisterToVault.ps1 -PSM -PSMAcceptEula Yes -PSMVaultIP \'{}\' -PSMVaultPort 1858 -PSMVaultUser {} -PSMVaultPassword {}'.format(args.vaultip, args.vaultuser, args.vaultpass)))
          services:
            windows:
              AmazonSSMAgent:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json
          commands:
            01-restartSSM:
              command: powershell.exe -Command "Restart-Service AmazonSSMAgent"
              waitAfterCompletion: '30'
              ignoreErrors: 'true'
            02-deploy:
              command:
                Fn::Sub:
                  - 'C:\Python27\python.exe C:\deploy.py ${VaultIpAddress} ${VaultAdminUser} ${VaultAdminPassword}'
                  - VaultIpAddress:
                      !If
                        - DRValueEmpty
                        - !Sub '${VaultPrivateIP}'
                        - !Sub '${VaultPrivateIP},${DRPrivateIP}'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            03-PSMserviceConfig:
              command: sc config "Cyber-Ark Privileged Session Manager" start=auto
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            04-ChangeHostName:
              command: !Sub 'powershell.exe -Command Rename-Computer -NewName ${ComponentHostName}
                -Force -Restart'
              waitAfterCompletion: forever
              ignoreErrors: 'false'
            99-SignalCompletion:
              command: !Sub 'cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource PSMMachine --region ${AWS::Region}'
    Condition: CreatePSMCondition
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    DeletionPolicy: Retain
  PSMPMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'ComponentInstanceName'
      SecurityGroupIds: !Ref 'ComponentInstanceSecurityGroups'
      SubnetId: !Ref 'ComponentInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - PSMP
      InstanceType: !Ref 'ComponentInstanceType'
      UserData: !Base64
        Fn::Sub: |
          #!/bin/bash -e
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource PSMPMachine --configsets install_all --region ${AWS::Region}
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource PSMPMachine --region ${AWS::Region}
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'ComponentInstanceProfile'
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          install_all:
            - install_logs
            - install_psmp
        install_logs:
          files:
            /etc/awslogs/awslogs.conf:
              content: !Sub |
                [general]
                state_file= /var/awslogs/state/agent-state
                [/var/log/cloud-init.log]
                file = /var/log/cloud-init.log
                log_group_name = ${LogGroup}
                log_stream_name = {instance_id}/cloud-init.log
                datetime_format = 
                [/var/log/cloud-init-output.log]
                file = /var/log/cloud-init-output.log
                log_group_name = ${LogGroup}
                log_stream_name = {instance_id}/cloud-init-output.log
                datetime_format = 
                [/var/log/cfn-init.log]
                file = /var/log/cfn-init.log
                log_group_name = ${LogGroup}
                log_stream_name = {instance_id}/cfn-init.log
                datetime_format = 
                [/var/log/cfn-wire.log]
                file = /var/log/cfn-wire.log
                log_group_name = ${LogGroup}
                log_stream_name = {instance_id}/cfn-wire.log
                datetime_format =               
              mode: '000444'
              owner: root
              group: root
            /etc/awslogs/awscli.conf:
              content: !Sub |
                [plugins]
                cwlogs = cwlogs
                [default]
                region = ${AWS::Region}
              mode: '000444'
              owner: root
              group: root
          commands:
            01_create_state_directory:
              command: mkdir -p /var/awslogs/state
          services:
            sysvinit:
              awslogs:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/awslogs/awslogs.conf
        install_psmp:
          files:
            /root/CD-Image/activatePSMP:
              content: |
                #!/bin/bash -e
                chmod 700 /root/CD-Image/register_and_activation.sh
                /opt/CARKpsmp/bin/createcredfile /root/CD-Image/user.cred Password -Username $2 -Password $3 -Hostname
                [ $? -eq 0 ]  || exit 1
                echo Credentials file successfully created.
                /root/CD-Image/register_and_activation.sh /root/CD-Image/user.cred $1 $(curl http://169.254.169.254/latest/meta-data/instance-id) y
                [ $? -eq 0 ]  || exit 1
                echo PSMP successfully registered to vault.
            /root/CD-Image/preinstall:
              content:
                Fn::Sub: |-
                  #!/bin/bash -e
                  hostname ${ComponentHostName}
                  sed -i 's/localhost\\./${ComponentHostName}./g' /etc/hosts
                  sed -i 's/localhost /${ComponentHostName} /g' /etc/hosts
                  chmod 646 /etc/sysconfig/network
                  sed -i 's/HOSTNAME=localhost.localdomain/HOSTNAME=${ComponentHostName}/g' /etc/sysconfig/network
                  chmod 644 /etc/hosts
                  chmod 644 /etc/sysconfig/network
                  chmod 700 /root/CD-Image/activatePSMP
            /root/CD-Image/postinstall:
              content:
                Fn::Sub: |-
                  #!/bin/bash -e
                  shred -u /root/CD-Image/activatePSMP
                  [ $? -eq 0 ]  || exit 1
                  rm -rf /root/CD-Image/
          commands:
            01-ScriptsPermissions:
              command: sudo chmod 700 /root/CD-Image/preinstall /root/CD-Image/activatePSMP /root/CD-Image/postinstall
            02-PreInstall:
              command: sudo /root/CD-Image/preinstall
            03-PSMPdeploy:
              command:
                Fn::Sub:
                  - 'sudo /root/CD-Image/activatePSMP ${VaultIpAddress} ${VaultAdminUser} ${VaultAdminPassword}'
                  - VaultIpAddress:
                      !If
                        - DRValueEmpty
                        - !Sub '${VaultPrivateIP}'
                        - !Sub '${VaultPrivateIP},${DRPrivateIP}'
            04-PostInstall:
              command: sudo /root/CD-Image/postinstall
            99-SignalCompletion:
              command: !Sub '/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource PSMPMachine --region ${AWS::Region}'
    Condition: CreatePSMPCondition
    CreationPolicy:
      ResourceSignal:
        Timeout: PT10M
    DeletionPolicy: Retain
Parameters:
  EULA:
    Type: String
    Description: I have read and agree to the Terms and Conditions.
    AllowedValues:
      - Accept
      - Decline
    Default: Decline
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Select an existing Key Pair from your AWS account.
    ConstraintDescription: Can contain only ASCII characters.
  VaultPrivateIP:
    Type: String
    Description: Enter the IP of the Vault instance.
  DRPrivateIP:
    Type: String
    Description: Enter the IP of the Vault DR instance. (Optional)
  VaultAdminUser:
    Type: String
    Description: Enter the Administrator Vault user.
    Default: Administrator
    MinLength: 8
  VaultAdminPassword:
    Type: String
    Description: Enter a password for the Vault Administrator user.
    NoEcho: true
    MinLength: 8
  ComponentToInstall:
    Type: String
    Description: Choose the Component to install.
    AllowedValues:
      - CPM
      - PVWA
      - PSM
      - PSMP
    Default: CPM
  ComponentInstanceName:
    Type: String
    Description: Enter a name for the PAS Component instance.
    Default: Components
  ComponentHostName:
    Type: String
    Description: Enter the host name for the PAS Component instance.
  ComponentInstanceType:
    Type: String
    Description: Select the instance type of the Component instance.
    AllowedValues:
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: m4.large
  ComponentInstanceSecurityGroups:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Assign Security Groups to the Component instance.
  ComponentInstanceSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Select the Subnet Id where the Component instance will reside.
  PVWAHostName:
    Type: String
    Description: IP or FQDN of PVWA server
Conditions:
  EULACondition: !Equals
    - Accept
    - !Ref 'EULA'
  CreateCPMCondition: !Equals
    - CPM
    - !Ref 'ComponentToInstall'
  CreatePVWACondition: !Equals
    - PVWA
    - !Ref 'ComponentToInstall'
  CreatePSMCondition: !Equals
    - PSM
    - !Ref 'ComponentToInstall'
  CreatePSMPCondition: !Equals
    - PSMP
    - !Ref 'ComponentToInstall'
  DRValueEmpty: !Equals
    - ''
    - !Ref 'DRPrivateIP'
  PVWAHostNameEmpty: !Equals
    - ''
    - !Ref 'PVWAHostName'
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General parameters
        Parameters:
          - EULA
          - KeyName
      - Label:
          default: Vault and DR information
        Parameters:
          - VaultPrivateIP
          - DRPrivateIP
          - VaultAdminUser
          - VaultAdminPassword
      - Label:
          default: Component configuration
        Parameters:
          - ComponentToInstall
          - ComponentInstanceName
          - ComponentHostName
          - ComponentInstanceType
          - ComponentInstanceSecurityGroups
          - ComponentInstanceSubnetId
          - PVWAHostName
    ParameterLabels:
      EULA:
        default: License Agreement
      KeyName:
        default: Key Pair
      VaultPrivateIP:
        default: Vault Private IP
      DRPrivateIP:
        default: Vault DR Private IP
      VaultAdminUser:
        default: Vault Admin User
      VaultAdminPassword:
        default: Vault Admin Password
      ComponentToInstall:
        default: Component To Install
      ComponentInstanceName:
        default: Component Instance Name
      ComponentHostName:
        default: Component Host Name
      ComponentInstanceType:
        default: Component Instance Type
      ComponentInstanceSecurityGroups:
        default: Component Instance Security Groups
      ComponentInstanceSubnetId:
        default: Component Instance Subnet Id
      PVWAHostName:
        default: PVWA FQDN (Optional)
Mappings:
  RegionMap:
    us-east-1:
      CPM: ami-0c5048832f0ba342b
      PVWA: ami-01512e92898f7ba04
      PSM: ami-08e096c0a3522f356
      PSMP: ami-0bb8f4622a32ccbbe
    us-east-2:
      CPM: ami-083b0f4f9d741d954
      PVWA: ami-0f945da6e23f077a9
      PSM: ami-09b4ac3bdeae933c0
      PSMP: ami-022c7e173b0e6e7c4
    eu-west-2:
      CPM: ami-07fd173db280acdd4
      PVWA: ami-08304728cfc488809
      PSM: ami-08f851be28facba76
      PSMP: ami-0e5eb6dfb2ad55e05
    us-west-1:
      CPM: ami-099bcb5ad7933f4ea
      PVWA: ami-04696a8ab6b72e55c
      PSM: ami-01eb3fb9c9c81365d
      PSMP: ami-056229e9b60431969
    us-west-2:
      CPM: ami-0e217872421f388da
      PVWA: ami-08d239a59b430d34e
      PSM: ami-08ee313797af3001f
      PSMP: ami-02643903bb58ccd9b
    ca-central-1:
      CPM: ami-0d30069a5fefbb76b
      PVWA: ami-0609dcbfc67c0ff0b
      PSM: ami-0ac9ec0e3a84f7d2f
      PSMP: ami-0169b158e5aedf114
    eu-west-1:
      CPM: ami-0e7871f260cff49cd
      PVWA: ami-06b533e49a82d0eaf
      PSM: ami-0c1aab51f2b76b3f3
      PSMP: ami-0fcc0e1d2a564297c
    eu-central-1:
      CPM: ami-0d80700930f21c822
      PVWA: ami-0f9f83f225903fa54
      PSM: ami-0d25e8bcf7b72ddc4
      PSMP: ami-0646e73bd35827fd3
    ap-southeast-1:
      CPM: ami-0f4c5e5d997518a87
      PVWA: ami-0cb6d24dcd607ec98
      PSM: ami-08f7c51d67091747f
      PSMP: ami-0e39d0b84ebb54e1a
    ap-southeast-2:
      CPM: ami-0ba04d0de7e57e96a
      PVWA: ami-03f90659c438a56c8
      PSM: ami-0221aac7e5aa4877e
      PSMP: ami-0d13566385aaaa992
    ap-northeast-2:
      CPM: ami-089d652381509cb91
      PVWA: ami-0d40187c0f8c4b8db
      PSM: ami-08ac621e8106f7ece
      PSMP: ami-04401539a5f3afc5c
    ap-northeast-1:
      CPM: ami-0e8fa7121b8b46482
      PVWA: ami-0fcb9f4bfab7f1b64
      PSM: ami-03de5e42ad5435e97
      PSMP: ami-0320b8464c30d2df8
    ap-south-1:
      CPM: ami-06abf8d5e4c0f3ba1
      PVWA: ami-076964d92284f16fa
      PSM: ami-000f302e84175b8ab
      PSMP: ami-02dc87adaa5c196da
    sa-east-1:
      CPM: ami-0c4d646f214dc2565
      PVWA: ami-0f7517ec36ced0752
      PSM: ami-0a0688382df21b7fa
      PSMP: ami-02129f1be6a069a69
    us-gov-west-1:
      CPM: ami-e94e6a88
      PVWA: ami-f2e2c693
      PSM: ami-13406472
      PSMP: ami-2c23044d
    us-gov-east-1:
      CPM: ami-084456b03a3ed8ab2
      PVWA: ami-062952a36194ca27e
      PSM: ami-07858426bb4179bfc
      PSMP: ami-06569e3bb5ab0cf98
Outputs:
  CloudWatchLogGroupName:
    Description: The name of the CloudWatch log group
    Value: !Ref 'LogGroup'
