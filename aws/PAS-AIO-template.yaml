Resources:
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 30
    DeletionPolicy: Retain
  VaultCfnInitLogStream:
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Sub '${LogGroup}'
      LogStreamName: 'VaultMachine/CfnInitLog'
    DeletionPolicy: Retain
  VaultInitLogStream:
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Sub '${LogGroup}'
      LogStreamName: 'VaultMachine/VaultInitLog'
    DeletionPolicy: Retain
  VaultPostInstallLogStream:
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Sub '${LogGroup}'
      LogStreamName: 'VaultMachine/VaultPostInstallLog'
    DeletionPolicy: Retain
  DeployBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
  LambdaDeployRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: CloudWatch
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Resource:
                  - '*'
        - PolicyName: SSM
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                Resource:
                  - !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*'
        - PolicyName: S3
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:ListBucket
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                Resource:
                  - !Sub 'arn:aws:s3:::${DeployBucket}/*'
                  - !Sub 'arn:aws:s3:::${VaultFilesBucket}/*'
    Condition: EULACondition
  LambdaLogDenyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: denyLambdaLogging
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Deny
                Action:
                  - logs:*
                Resource: '*'
  StorePasswordLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Saves given password to parameter store as SecureString
      Code:
        ZipFile: |-
          import uuid
          import boto3
          import cfnresponse
          def storePassword(name, value):
            ssmClient = boto3.client('ssm')
            return ssmClient.put_parameter(
                Name = name,
                Value = value,
                Type = 'SecureString'
            )
          
          def deletePassword(name):
            ssmClient = boto3.client('ssm')
            return ssmClient.delete_parameter(
                Name = name
            )
          
          def lambda_handler(event, context):
          
            physicalResourceId = str(uuid.uuid4())
            if 'PhysicalResourceId' in event:
              physicalResourceId = event['PhysicalResourceId']
        
            if 'Password' not in event['ResourceProperties'] or not event['ResourceProperties']['Password']:
              print 'The property Password must not be empty'
              return cfnresponse.send(event, context, cfnresponse.FAILED,{}, physicalResourceId)
        
            try:
              if event['RequestType'] == 'Delete':
                deletePassword(physicalResourceId)
                print 'Password successfully deleted. Id='+physicalResourceId
                return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
        
                if event['RequestType'] == 'Create':
                  storePassword(physicalResourceId, event['ResourceProperties']['Password'])
                  print 'The store parameter has been created. Id='+physicalResourceId
                  response = { 'SsmId': physicalResourceId }
                  return cfnresponse.send(event, context, cfnresponse.SUCCESS,response, physicalResourceId)
          
              except client.exceptions.ParameterNotFound:
                print 'Item already removed'
                return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
              except Exception as E:
                print E
                return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)'
      Runtime: python2.7
      Handler: index.lambda_handler
      Timeout: 60
      Role: !GetAtt 'LambdaDeployRole.Arn'
    Condition: EULACondition
  DeletePasswordLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Delete password from parameter store
      Code:
        ZipFile: |-
          import uuid
          import boto3
          import cfnresponse
          
          def deletePassword(name):
            ssmClient = boto3.client('ssm')
            return ssmClient.delete_parameter( Name = name)
          
          def lambda_handler(event, context):
            physicalResourceId = str(uuid.uuid4())
            if 'PhysicalResourceId' in event:
              physicalResourceId = event['PhysicalResourceId']
            
            try:
              if event['RequestType'] == 'Create':
                deletePassword(event['ResourceProperties']['key'])
                print 'Password succesfully deleted. Id='+event['ResourceProperties']['key']
                return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
              if event['RequestType'] == 'Delete':
                return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
        
            except client.exceptions.ParameterNotFound:
              print 'Item already removed'
              return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
            except Exception as E:
              print E
              return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)'
      Runtime: python2.7
      Handler: index.lambda_handler
      Timeout: 60
      Role: !GetAtt 'LambdaDeployRole.Arn'
    Condition: EULACondition
  CopyfileFromBucketLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Copy files from foreign region to local region
      Code:
        ZipFile: |-
          import uuid
          import boto3
          import cfnresponse
          
          def CopyFileFromBucketToBucket(bucket, fileKey, destination, destBucket):
            s3Client = boto3.client(''s3'')
            copy_source = {''Bucket'': bucket,''Key'': fileKey}
            s3Client.copy_object(CopySource=copy_source, Bucket=destBucket, Key=destination)  
          def DeleteObjectFromBucket(bucket, key):
            s3Client = boto3.client(''s3'')
            s3Client.delete_object(Bucket=bucket, Key=key)
          
          def lambda_handler(event, context):
              physicalResourceId = str(uuid.uuid4())
              if ''PhysicalResourceId'' in event:
                physicalResourceId = event[''PhysicalResourceId'']
          
              try:
                if event[''RequestType''] == ''Delete'':
                  DeleteObjectFromBucket(event[''ResourceProperties''][''DestBucket''],event[''ResourceProperties''][''FileKey''])
                  print ''Object Deleted Successfully''
                  return cfnresponse.send(event, context, cfnresponse.SUCCESS,{}, physicalResourceId)
          
                if event[''RequestType''] == ''Create'':
                  CopyFileFromBucketToBucket(event['ResourceProperties']['BucketName'],event['ResourceProperties']['FileKey'],event['ResourceProperties']['FileName'],event['ResourceProperties']['DestBucket'])
                  print ''file copied successfully''
                  return cfnresponse.send(event, context, cfnresponse.SUCCESS, {}, physicalResourceId)
          
              except Exception as E:
                  print E
                  return cfnresponse.send(event, context, cfnresponse.FAILED, {}, physicalResourceId)'
      Runtime: python2.7
      Handler: index.lambda_handler
      Role: !GetAtt 'LambdaDeployRole.Arn'
  StoreMasterPassword:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'StorePasswordLambda.Arn'
      Password: !Ref 'VaultMasterPassword'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
  StoreAdminPassword:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt 'StorePasswordLambda.Arn'
      Password: !Ref 'VaultAdminPassword'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
  CleanMasterPassword:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'DeletePasswordLambda.Arn'
      key: !GetAtt 'StoreMasterPassword.SsmId'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
      - StorePasswordLambda
      - VaultMachine
  CleanAdminPassword:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'DeletePasswordLambda.Arn'
      key: !GetAtt 'StoreAdminPassword.SsmId'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
      - StorePasswordLambda
      - ComponentsMachine
  CopyLicenseToBucket:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'CopyfileFromBucketLambda.Arn'
      BucketName: !Ref 'VaultFilesBucket'
      FileKey: !Ref 'LicenseFile'
      FileName: !Ref 'LicenseFile'
      DestBucket: !Ref 'DeployBucket'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
  CopyRecpubToBucket:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt 'CopyfileFromBucketLambda.Arn'
      BucketName: !Ref 'VaultFilesBucket'
      FileKey: !Ref 'RecoveryPublicKey'
      FileName: !Ref 'RecoveryPublicKey'
      DestBucket: !Ref 'DeployBucket'
    Condition: EULACondition
    DependsOn:
      - LambdaDeployRole
  VaultMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'VaultInstanceName'
      SecurityGroupIds: !Ref 'VaultInstanceSecurityGroups'
      SubnetId: !Ref 'VaultInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - Vault
      InstanceType: !Ref 'VaultInstanceType'
      UserData: !Base64
        Fn::Sub: |-
          <script>
          cfn-init.exe -v -s ${AWS::StackId} VaultMachine --region ${AWS::Region}
          cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource VaultMachine --region ${AWS::Region}
          </script>
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'VaultInstancesProfile'
    Metadata:
      AWS::CloudFormation::Init:
        config:
          services:
            windows:
              AmazonSSMAgent:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json
          commands:
            1-downloadLatestSSM:
              command: >
                powershell.exe -Command [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest "https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/windows_amd64/AmazonSSMAgentSetup.exe" -OutFile "$env:USERPROFILE\Desktop\SSMAgent_latest.exe" -UseBasicParsing
              waitAfterCompletion: '0'
              ignoreErrors: 'true'
            2-updateLatestSSM:
              command: >
                powershell.exe -Command Start-Process -FilePath $env:USERPROFILE\Desktop\SSMAgent_latest.exe -ArgumentList "/S" -Wait
              waitAfterCompletion: '0'
              ignoreErrors: 'true'
            3-removeLatestSSM:
              command: >
                powershell.exe -Command rm -Force $env:USERPROFILE\Desktop\SSMAgent_latest.exe
              waitAfterCompletion: '0'
              ignoreErrors: 'true'
            4-configcw:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\CloudWatch.ps1 -LogGroup ${LogGroup} -CfnInitLogStream ${VaultCfnInitLogStream} -VaultInitLogStream ${VaultInitLogStream} -VaultPostInstallLogStream ${VaultPostInstallLogStream} -Region ${AWS::Region}
              waitAfterCompletion: '10'
            5-restartSSM:
              command: powershell.exe -Command "Restart-Service AmazonSSMAgent"
              waitAfterCompletion: '60'
        configServices:
          commands:
            1-download:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\VaultInit.ps1 -VaultFilesBucket ${VaultFilesBucket} -LicenseFileKey ${LicenseFile} -RecoveryPublicKey ${RecoveryPublicKey} -Region ${AWS::Region}
              waitAfterCompletion: '0'
            2-postInstall:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\VaultPostInstall.ps1 -SSMMasterPassParameterID ${StoreMasterPassword.SsmId} -SSMAdminPassParameterID ${StoreAdminPassword.SsmId} -LicensePath "C:\CyberArk\Deployment\vaultLicense.xml" -RecoveryPublicKeyPath "C:\CyberArk\Deployment\recoveryPublic.key" -Region ${AWS::Region}
              waitAfterCompletion: '0'
            3-removePermissions:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\VaultRemoveIAMPolicies.ps1 -Role ${VaultInstancesRole}
              waitAfterCompletion: '0'
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    DependsOn:
      - CopyLicenseToBucket
      - CopyRecpubToBucket
  VaultInstancesProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'VaultInstancesRole'
    Condition: EULACondition
  RandomStringLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          const response = require("./cfn-response");
          const randomString = (length, chars) => {
              var result = '';
              for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
              return result;
          }
          exports.handler = (event, context) =>{

            const str = randomString(1, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ') + randomString(1, 'abcdefghijklmnopqrstuvwxyz') + randomString(3, '0123456789') + randomString(11, 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ');
            const responseData = {RandomString: str};
            response.send(event, context, response.SUCCESS, responseData);

          };
      Handler: index.handler
      Runtime: nodejs10.x
      Role: !GetAtt 'LambdaLogDenyRole.Arn'
      MemorySize: 128
      Timeout: 20
  ComponentSecretString:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt 'RandomStringLambdaFunction.Arn'
  ComponentInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref 'ComponentInstanceRole'
    Condition: EULACondition
  ComponentInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
      Policies:
        - PolicyName: LogRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource:
                  - !Sub 'arn:${AWS::Partition}:logs:*:*:*'
    Condition: EULACondition
  VaultInstancesRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
      Policies:
        - PolicyName: LogRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource:
                  - !Sub 'arn:${AWS::Partition}:logs:*:*:*'
    Condition: EULACondition
  InstancesSSMPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: InstancesSsmAccess
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*'
      Roles:
        - !Ref 'ComponentInstanceRole'
        - !Ref 'VaultInstancesRole'
    Condition: EULACondition
  VaultInstancesKMSPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: VaultInstancesKMSAccess
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
            Resource: '*'
      Roles:
        - !Ref 'VaultInstancesRole'
    Condition: EULACondition
  VaultInstancesS3VaultFilesBucketPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: VaultFilesBucketAccess
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource: !Sub 'arn:${AWS::Partition}:s3:::${VaultFilesBucket}/*'
      Roles:
        - !Ref 'VaultInstancesRole'
    Condition: EULACondition
  VaultBootstrapKMSPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: VaultBootstrapKMSAccess
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - kms:CreateKey
              - kms:GenerateRandom
            Resource: '*'
      Roles:
        - !Ref 'VaultInstancesRole'
  ComponentsMachine:
    Type: AWS::EC2::Instance
    Properties:
      Tags:
        - Key: Name
          Value: !Ref 'ComponentsInstanceName'
      SecurityGroupIds: !Ref 'ComponentsInstanceSecurityGroups'
      SubnetId: !Ref 'ComponentsInstanceSubnetId'
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - Components
      InstanceType: !Ref 'ComponentsInstanceType'
      UserData: !Base64
        Fn::Sub: |-
          <script>
          cfn-init.exe -v -s ${AWS::StackId}-r ComponentsMachine --region ${AWS::Region}
          cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource ComponentsMachine --region ${AWS::Region}
          </script>
      KeyName: !Ref 'KeyName'
      IamInstanceProfile: !Ref 'ComponentInstanceProfile'
    Metadata:
      AWS::CloudFormation::Init:
        config:
            windows:
              AmazonSSMAgent:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - C:\Program Files\Amazon\SSM\Plugins\awsCloudWatch\AWS.EC2.Windows.CloudWatch.json
        commands:
            01-restartSSM:
              command: powershell.exe -Command "Restart-Service AmazonSSMAgent"
              waitAfterCompletion: '30'
              ignoreErrors: 'true'
            02-PVWAdeploy:
              command: C:\Python27\python.exe C:\deployPVWA.py
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            03-StartAppPool:
              command: >-
                powershell -command "& {&'Import-Module' WebAdministration}"; "& {&'Start-WebAppPool'
                -Name PasswordVaultWebAccessPool}"; "& {&'Set-ItemProperty' -Path
                IIS:\AppPools\PasswordVaultWebAccessPool -Name autoStart -Value 'true'}"
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            04-configurePVWAUser:
              command:
                - powershell.exe -Command -File C:\Set-LocalAccountPassword.ps1 -Username "PVWAReportsUser" -Password !GetAtt 'ComponentSecretString.RandomString'
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            101-configurePVWAService:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\Set-LocalService.ps1
                -Username "PVWAReportsUser" -Services "CyberArk Scheduled Tasks"
              waitAfterCompletion: '0'
            102-configuration:
              command: !Sub 
                - >-
                  powershell.exe -File
                  C:\CyberArk\Deployment\PVWAConfiguration.ps1 -VaultIpAddress
                  ${VaultIpAddress} -VaultAdminUser ${VaultAdminUser} -VaultPort
                  1858 -HostName ${InputHostname}
                - VaultIpAddress: !If 
                    - DRValueEmpty
                    - !Sub '${VaultPrivateIP}'
                    - !Sub '${VaultPrivateIP}'
                  InputHostname: !If 
                    - PVWAHostNameEmpty
                    - empty
                    - !Sub '${PVWAHostName}'
              waitAfterCompletion: '0'
            103-registration:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\PVWARegistration.ps1
                -VaultAdminUser ${VaultAdminUser} -SSMAdminPassParameterID
                ${StoreAdminPassword.SsmId}
              waitAfterCompletion: '0'
            104-startAppPool:
              command: >-
                powershell -Command "& {&'Import-Module' WebAdministration}"; "&
                {&'Start-WebAppPool' -Name PasswordVaultWebAccessPool}"; "&
                {&'Set-ItemProperty' -Path
                IIS:\AppPools\PasswordVaultWebAccessPool -Name autoStart -Value
                'true'}"
              waitAfterCompletion: '0'
            105-CSTserviceConfig:
              command: sc config "CyberArk Scheduled Tasks" start=auto
              waitAfterCompletion: '0'
            200-configureCPMService:
              command: 
                - powershell.exe -File C:\Set-LocalService.ps1 -Services "CyberArk Scheduled Tasks" -UserName 
              waitAfterCompletion: '0'
              ignoreErrors: 'false'
            201-configuration:
              command: !Sub 
                - >-
                  powershell.exe -File
                  C:\CyberArk\Deployment\CPMConfiguration.ps1 -VaultIpAddress
                  ${VaultIpAddress} -VaultAdminUser ${VaultAdminUser} -VaultPort
                  1858
                - VaultIpAddress: !If 
                    - DRValueEmpty
                    - !Sub '${VaultPrivateIP}'
                    - !Sub '${VaultPrivateIP}'
              waitAfterCompletion: '0'
            202-registration:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\CPMRegistration.ps1
                -VaultAdminUser ${VaultAdminUser} -SSMAdminPassParameterID
                ${StoreAdminPassword.SsmId}
              waitAfterCompletion: '0'
            203-configureCPMService:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\Set-LocalService.ps1
                -Username "PasswordManagerUser" -Services "CyberArk Central
                Policy Manager Scanner"
              waitAfterCompletion: '0'
            204-configureCPMService:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\Set-LocalService.ps1
                -Username "PasswordManagerUser" -Services "CyberArk Password
                Manager"
              waitAfterCompletion: '0'
            205-CPMserviceConfig:
              command: sc config "CyberArk Password Manager" start=auto
              waitAfterCompletion: '0'
            206-CPMSserviceConfig:
              command: sc config "CyberArk Central Policy Manager Scanner" start=auto
              waitAfterCompletion: '0'
            301-configuration:
              command: !Sub 
                - >-
                  powershell.exe -File
                  C:\CyberArk\Deployment\PSMConfiguration.ps1 -VaultIpAddress
                  ${VaultIpAddress} -VaultAdminUser ${VaultAdminUser} -VaultPort
                  1858
                - VaultIpAddress: !If 
                    - DRValueEmpty
                    - !Sub '${VaultPrivateIP}'
                    - !Sub '${VaultPrivateIP}'
              waitAfterCompletion: '0'
            302-registration:
              command: !Sub >
                powershell.exe -File C:\CyberArk\Deployment\PSMRegistration.ps1
                -VaultAdminUser ${VaultAdminUser} -SSMAdminPassParameterID
                ${StoreAdminPassword.SsmId}
              waitAfterCompletion: '0'
            303-PSMserviceConfig:
              command: sc config "Cyber-Ark Privileged Session Manager" start=auto
              waitAfterCompletion: '0'
            98-SignalCompletion:
              command: !Sub 'cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackId} --resource ComponentsMachine --region ${AWS::Region}'
            99-restart:
              command: powershell.exe -Command "Restart-Computer -Force"
              waitAfterCompletion: forever  
    CreationPolicy:
      ResourceSignal:
        Timeout: PT20M
Parameters:
  EULA:
    Type: String
    Description: I have read and agree to the Terms and Conditions.
    AllowedValues:
      - Accept
      - Decline
    Default: Decline
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Select an existing Key Pair from your AWS account.
    ConstraintDescription: Can contain only ASCII characters.
  VaultFilesBucket:
    Type: String
    Description: Enter the name of the bucket containing the license and recovery
      public key.
  LicenseFile:
    Type: String
    Description: Enter the path of the license file within the bucket.
    Default: license.xml
  RecoveryPublicKey:
    Type: String
    Description: Enter the path of the recovery public key file within the bucket.
    Default: recpub.key
  VaultInstanceName:
    Type: String
    Description: Enter a name for the Vault instance.
    Default: CyberArk Vault
  VaultMasterPassword:
    Type: String
    Description: Enter a password for the Vault Master user.
    NoEcho: true
    MinLength: 8
    AllowedPattern: ^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&\*\(\)_\-+=:])(?=\S+$).{8,}$
    ConstraintDescription: Vault Master password must contain at least 1 lowercase
      letter, 1 uppercase letter, 1 digit and 1 special character
  RetypeMasterPassword:
    Type: String
    Description: Retype the password for the Vault Master user.
    NoEcho: true
    MinLength: 8
  VaultAdminPassword:
    Type: String
    Description: Enter a password for the Vault Administrator user.
    NoEcho: true
    MinLength: 8
    AllowedPattern: ^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&\*\(\)_\-+=:])(?=\S+$).{8,}$
    ConstraintDescription: Vault Administrator password must contain at least 1 lowercase
      letter, 1 uppercase letter, 1 digit and 1 special character
  RetypeAdminPassword:
    Type: String
    Description: Retype the password for the Vault Administrator user.
    NoEcho: true
    MinLength: 8
  VaultInstanceType:
    Type: String
    Description: Select the instance type of the Vault instance.
    AllowedValues:
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: m4.large
  VaultInstanceSecurityGroups:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Assign Security Groups to the Vault instance.
  VaultInstanceSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Select the Subnet Id where the Vault instance will reside.
  ComponentsInstanceName:
    Type: String
    Description: Enter a name for the PAS Components instance.
    Default: CyberArk Components
  ComponentsInstanceType:
    Type: String
    Description: Select the instance type of the PAS Components instance.
    AllowedValues:
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: m4.large
  ComponentsInstanceSecurityGroups:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Assign Security Groups to the PAS Components instance.
  ComponentsInstanceSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Select the Subnet Id where the PAS Components instance will reside.
Conditions:
  EULACondition: !Equals
    - Accept
    - !Ref 'EULA'
Rules:
  PasswordConfirmation:
    Assertions:
      - Assert: !Equals
          - !Ref 'VaultMasterPassword'
          - !Ref 'RetypeMasterPassword'
        AssertDescription: The password confirmation does not match.
      - Assert: !Equals
          - !Ref 'VaultAdminPassword'
          - !Ref 'RetypeAdminPassword'
        AssertDescription: The password confirmation does not match.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Parameters
        Parameters:
          - EULA
          - KeyName
          - VaultFilesBucket
          - LicenseFile
          - RecoveryPublicKey
      - Label:
          default: Vault Configuration
        Parameters:
          - VaultInstanceName
          - VaultMasterPassword
          - RetypeMasterPassword
          - VaultAdminPassword
          - RetypeAdminPassword
          - VaultInstanceType
          - VaultInstanceSecurityGroups
          - VaultInstanceSubnetId
      - Label:
          default: Components Configuration
        Parameters:
          - ComponentsInstanceName
          - ComponentsInstanceType
          - ComponentsInstanceSecurityGroups
          - ComponentsInstanceSubnetId
    ParameterLabels:
      EULA:
        default: License Agreement
      KeyName:
        default: Key Pair
      VaultFilesBucket:
        default: Vault Files Bucket
      LicenseFile:
        default: License File
      RecoveryPublicKey:
        default: Recovery Public Key
      VaultInstanceName:
        default: Vault Instance Name
      VaultMasterPassword:
        default: Vault Master Password
      RetypeMasterPassword:
        default: Retype Master Password
      VaultAdminPassword:
        default: Vault Admin Password
      RetypeAdminPassword:
        default: Retype Admin Password
      VaultInstanceType:
        default: Vault Instance Type
      VaultInstanceSecurityGroups:
        default: Vault Instance Security Groups
      VaultInstanceSubnetId:
        default: Vault Instance Subnet Id
      ComponentsInstanceName:
        default: Components Instance Name
      ComponentsInstanceType:
        default: Components Instance Type
      ComponentsInstanceSecurityGroups:
        default: Components Instance Security Groups
      ComponentsInstanceSubnetId:
        default: Components Instance Subnet Id
Mappings:
  RegionMap:
    us-east-1:
      Vault: ami-01d4a7bd46088f700
      Components: ami-008819e4bd2bc224a
    us-east-2:
      Vault: ami-068bc4ecc92db8199
      Components: ami-0760243808377180b
    eu-west-2:
      Vault: ami-0a559ff9a29efa431
      Components: ami-0ab86c6797fe2abf2
    us-west-1:
      Vault: ami-0f1803a9c76472be5
      Components: ami-0863710cb43917155
    us-west-2:
      Vault: ami-01edee6e967c17628
      Components: ami-018feb9b22c05d200
    ca-central-1:
      Vault: ami-0582d8c1a70001244
      Components: ami-0894c7f96641784ad
    eu-west-1:
      Vault: ami-09397273b9046d5b9
      Components: ami-0ff819a9eaff529bc
    eu-central-1:
      Vault: ami-06f43402c6e002660
      Components: ami-0cf15ea5528530c06
    ap-southeast-1:
      Vault: ami-0872cf43e69e28466
      Components: ami-04f431192f05c65ae
    ap-southeast-2:
      Vault: ami-0a02581b7c2a55e6f
      Components: ami-0e9e29f304c5cda9e
    ap-northeast-2:
      Vault: ami-0ed3745003fa46976
      Components: ami-0c4ce79c5a137c32c
    ap-northeast-1:
      Vault: ami-02e14fe4621742bde
      Components: ami-09601db9cb2a5d387
    ap-south-1:
      Vault: ami-0ff8fe4a731baa07a
      Components: ami-0f7ab50ee1a191e45
    sa-east-1:
      Vault: ami-04b91be9198835fc8
      Components: ami-0eee7030bbc34d5d8
    us-gov-west-1:
      Vault: ami-0e87a36f
      Components: ami-e1220580
    us-gov-east-1:
      Vault: ami-00268514ee37890b9
      Components: ami-0311b01fc5b67d05f
Outputs:
  CloudWatchLogGroupName:
    Description: The name of the CloudWatch log group
    Value: !Ref 'LogGroup'