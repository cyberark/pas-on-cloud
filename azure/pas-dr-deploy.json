{
    "$schema": "http://schema-management-azure-com.o365.apps.cyberark.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "License Agreement": {
            "defaultValue": "Decline",
            "allowedValues": [
                "Accept",
                "Decline"
            ],
            "maxLength": 6,
            "type": "String",
            "metadata": {
                "description": "I have read and agree to the Terms and Conditions."
            }
        },
        "Key Vault Name":{
         "type":"String",
         "minLength":4,
         "maxLength":24,
         "metadata":{
            "description":"Enter the name of the Key Vault. Note: To avoid deployment failure, validate in advance that your Key Vault Name is available"
            }
        },
        "Primary Vault Private IP": {
            "type": "String",
            "metadata": {
                "description": "Enter the Vault Private IP"
            }
        },
        "DR Username Secret":{
            "type":"String",
            "minLength":10,
            "defaultValue": "",
            "metadata":{
            "description":"Enter the secret string for the DR user that was set on the Primary Vault"
            }
        },
        "DR Username":{
            "minLength":4,
            "maxLength":24,
            "type":"String",
            "metadata":{
            "description":"Enter the Vault DR Username that will be linked to this Vault DR instance. You must allow registration to this Vault DR user on the Primary Vault before continuing this operation."
            }
        },
        "Vault DR Password": {
            "type": "SecureString",
            "metadata": {
                "description": "Enter a password for the Vault DR user."
            }
        },
        "Vault DR VM Name": {
            "type": "String",
            "metadata": {
                "description": "Enter the host name for the PAS Vault DR VM."
            }
        },
        "Vault DR VM Size": {
            "defaultValue": "Standard_D2s_v3",
            "type": "String",
            "metadata": {
                "description": "Enter the desired VM Size"
            }
        },
        "Vault DR VM Admin User": {
            "type": "String",
            "metadata": {
                "description": "Enter Vault DR VM Administrator user."
            }
        },
        "Vault DR VM Admin Password": {
            "type": "SecureString",
            "metadata": {
                "description": "Enter Vault DR VM Administrator password."
            }
        },
        "ImageID": {
            "type": "String",
            "metadata": {
                "description": "Enter Vault DR Image ID."
            }
        },
        "Availability Zone":{
            "type":"string",
            "allowedValues": [
                "1",
                "2",
                "3"
            ],
            "defaultValue": "2",
            "metadata":{
               "description":"Choose the availability zone for the DR Vault  VM"
            }
         },
        "Vault DR VNet Name":{
            "type":"String",
            "defaultValue": "PAS-VNet",
            "metadata":{
               "description":"Enter the VNet for the DR Vault VM"
            }
         },
         "Vault DR Subnet Name":{
            "type":"String",
            "defaultValue": "Vault-Subnet",
            "metadata":{
               "description":"Enter the Subnet for the DR Vault VM"
            }
         }
    },
    "variables": {
        "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('Vault DR VNet Name')]",
        "subnetRefVault": "[concat(variables('vnetId'), '/subnets/','Vault-DR-Subnet')]",
        "networkInterfaceName": "[toLower(concat(parameters('Vault DR VM Name'), '-', uniqueString(resourceGroup().id)))]",
        "publicIpAddressName": "[toLower(concat(parameters('Vault DR VM Name'), '-', uniqueString(resourceGroup().id)))]"
    },
    "resources": [
        {
           "type":"Microsoft.Resources/deployments",
           "name": "pid-920ca5c9-254e-5fa2-87f3-eba1b62dc92d",
           "apiVersion": "2018-02-01",
           "properties":{
              "mode":"incremental",
              "template":{
                 "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                 "contentVersion":"1.0.0.0",
                 "resources": []
              }
           }
        },
        {
            "condition": "[not(equals(parameters('Key Vault Name'),'null'))]",
            "type":"Microsoft.KeyVault/vaults",
            "name":"[parameters('Key Vault Name')]",
            "apiVersion":"2015-06-01",
            "location":"[resourceGroup().location]",
            "properties":{
               "tenantId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('DR Vault VM Name')), '2017-03-30', 'Full').identity.tenantId]",
               "accessPolicies":[
                  {
                     "tenantId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('DR Vault VM Name')), '2017-03-30', 'Full').identity.tenantId]",
                     "objectId":"[reference(concat('Microsoft.Compute/virtualMachines/', parameters('DR Vault VM Name')), '2017-03-30', 'Full').identity.principalId]",
                     "permissions":{
                        "keys":[
                           "create",
                           "wrapKey",
                           "unwrapKey"
                        ]
                     }
                  }
               ],
               "sku":{
                  "family":"A",
                  "name":"Premium"
               },
               "networkAcls":{
                  "bypass":"None",
                  "defaultAction":"Deny",
                  "virtualNetworkRules":[
                     {
                        "id":"[variables('subnetRefVault')]"
                     }
                  ]
               }
            },
            "dependsOn":[
               "[concat('Microsoft.Compute/virtualMachines/', parameters('DR Vault VM Name'))]"
            ]
         },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('Vault DR VM Name'),'/ManagedIdentityExtensionForWindows')]",
            "apiVersion": "2018-06-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "publisher": "Microsoft.ManagedIdentity",
                "type": "ManagedIdentityExtensionForWindows",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "port": 50342
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('Vault DR VM Name'))]"
            ]
        },
        {
            "type": "Microsoft.KeyVault/vaults/accessPolicies",
            "name": "[concat(parameters('Key Vault Name'), '/add')]",
            "apiVersion": "2016-10-01",
            "properties": {
                "accessPolicies": [
                    {
                        "tenantId": "[reference(concat('Microsoft.Compute/virtualMachines/', parameters('Vault DR VM Name')), '2017-03-30', 'Full').identity.tenantId]",
                        "objectId": "[reference(concat('Microsoft.Compute/virtualMachines/', parameters('Vault DR VM Name')), '2017-03-30', 'Full').identity.principalId]",
                        "permissions": {
                            "keys": [
                                "create","wrapKey","unwrapKey"
                            ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[parameters('Vault DR VM Name')]",
            "apiVersion": "2017-03-30",
            "location": "[resourceGroup().location]",
            "zones": [
                "[parameters('Availability Zone')]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "osProfile": {
                    "computerName": "[parameters('Vault DR VM Name')]",
                    "adminUsername": "[parameters('Vault DR VM Admin User')]",
                    "adminPassword": "[parameters('Vault DR VM Admin Password')]",
                    "windowsConfiguration": {
                        "provisionVmAgent": "true"
                    }
                },
                "hardwareProfile": {
                    "vmSize": "[parameters('Vault DR VM Size')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "id": "[parameters('ImageID')]"
                    },
                    "osDisk": {
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
            ]
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('Vault DR VM Name'),'/', 'customscript')]",
            "apiVersion": "2015-06-15",
            "location": "[resourceGroup().location]",
            "tags": {
                "displayName": "activate-vault"
            },
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.9",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": []
                },
                "protectedSettings": {
					"commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -file ', 'C:\\CyberArk\\HardeningActivation.ps1', ' -AdminPass ', parameters('Vault DR Administrator Password'), ' -PrimaryOrDR DR ', ' -PrimaryVaultIP ', parameters('Vault Private IP'), ' -DRPassword ', parameters('Vault DR Password'),' -DRUser ', parameters('DR Username'), ' -VKMName ', parameters('Key Vault Name'), ' -Secret ', parameters('DR Username Secret'))]"
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('Vault DR VM Name'), '/extensions/ManagedIdentityExtensionForWindows')]"
            ]
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[variables('networkInterfaceName')]",
            "apiVersion": "2016-09-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnetRefVault')]"
                            },
                            "privateIPAllocationMethod": "Dynamic"
                        }
                    }
                ]
            }
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "String",
            "value": "[parameters('Vault DR VM Admin User')]"
        },
        "networkInterface": {
            "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName')),'2016-09-01')]",
            "type": "object"
        }
    }
}
